<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Calendar & Tasks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .login-container h1 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }

        .login-container input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .login-container button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .main-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        .calendar-container,
        .tasks-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tasks-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .controls {
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .month-nav button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .month-nav h2 {
            min-width: 200px;
            text-align: center;
            color: #333;
        }

        .add-event-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            padding: 20px;
            gap: 10px;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            color: #667eea;
        }

        .day-cell {
            min-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            background: white;
        }

        .day-cell.other-month {
            opacity: 0.3;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .event-item {
            font-size: 11px;
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 3px;
            color: white;
            white-space: normal;
            overflow-wrap: break-word;
            display: flex;
            align-items: flex-start;
            gap: 4px;
            line-height: 1.3;
            position: relative;
            /* For tooltip positioning */
        }

        .event-item:hover {
            z-index: 10;
            /* Bring to front on hover */
        }

        /* Month Dropdown Styles */
        .month-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            min-width: 180px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1000;
            padding: 5px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
        }

        .month-option {
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s;
            text-align: center;
            color: #333;
            font-size: 14px;
        }

        .month-option:hover {
            background: #f0f0f0;
        }

        .month-option.current {
            font-weight: bold;
            color: #667eea;
            background: #f8f9fa;
        }

        /* Tooltip Styles */
        .event-tooltip {
            visibility: hidden;
            width: 220px;
            background-color: rgba(20, 20, 20, 0.95);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 100;
            bottom: 115%;
            /* Position above */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, bottom 0.2s;
            font-size: 12px;
            line-height: 1.4;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            white-space: normal;
        }

        .event-item:hover .event-tooltip {
            visibility: visible;
            opacity: 1;
            bottom: 125%;
            /* Slight animation up */
        }

        .event-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(20, 20, 20, 0.95) transparent transparent transparent;
        }

        .event-item.repeating::after {
            content: 'üîÅ';
            font-size: 10px;
            margin-left: auto;
        }

        .tasks-content {
            padding: 20px 30px;
            max-height: 500px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .task-icon {
            font-size: 20px;
        }

        .task-details {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: #333;
        }

        .task-title.completed {
            text-decoration: line-through;
            color: #999;
        }

        .task-category {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .task-actions {
            display: flex;
            gap: 5px;
        }

        .task-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .repeat-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .repeat-option {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
        }

        .repeat-option.selected {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .icon-selector {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .icon-option {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 20px;
        }

        .icon-option.selected {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .save-btn {
            background: #27ae60;
            color: white;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .cancel-btn {
            background: #95a5a6;
            color: white;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }

        .category-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .category-actions {
            display: flex;
            gap: 5px;
        }

        .edit-category,
        .remove-category {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-category {
            background: #3498db;
            color: white;
        }

        .remove-category {
            background: #e74c3c;
            color: white;
        }

        .add-category-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .add-category-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .color-swatch {
            width: 100%;
            padding-top: 100%;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .color-swatch.selected {
            border-color: #333;
            transform: scale(1.1);
        }

        /* Print Styles */
        @media print {
            @page {
                size: landscape;
                margin: 0.5cm;
            }

            body {
                background: white !important;
                padding: 0 !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .login-container,
            .main-container,
            .modal,
            .header-buttons,
            .controls,
            .add-event-btn {
                display: none !important;
            }

            #printContainer {
                display: block !important;
                width: 100%;
            }

            .print-page {
                width: 100%;
                height: 95vh;
                page-break-after: always;
                display: flex;
                flex-direction: column;
            }

            .print-header {
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 10px;
                padding: 10px;
                background: #eee;
                border-radius: 4px;
            }

            .print-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 0;
                border: 1px solid #999;
                flex: 1;
            }

            .print-day-header {
                text-align: center;
                border-bottom: 1px solid #999;
                border-right: 1px solid #999;
                padding: 5px;
                background: #f0f0f0;
                font-weight: bold;
            }

            .print-cell {
                border-right: 1px solid #999;
                border-bottom: 1px solid #999;
                padding: 4px;
                vertical-align: top;
                min-height: 80px;
                position: relative;
            }

            .print-cell.other-month {
                background: #f9f9f9;
                opacity: 0.5;
            }

            .print-date-num {
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 4px;
            }

            .print-event {
                font-size: 10px;
                margin-bottom: 2px;
                padding: 2px 4px;
                border-radius: 3px;
                background: #eee;
                color: white;
                white-space: normal;
                overflow-wrap: break-word;
            }
        }

        #printContainer {
            display: none;
        }
    </style>
</head>

<body>

    <div class="login-container" id="loginContainer">
        <h1>üîí Calendar Login</h1>
        <div id="errorMessage" class="error-message"></div>
        <input type="password" id="passwordInput" placeholder="Enter your password"
            onkeyup="if(event.key==='Enter')login()" />
        <button onclick="login()">Login</button>
        <p style="margin-top: 20px; font-size: 12px; color: #999; text-align: center;">First time? Set your password</p>
    </div>

    <div class="main-container" id="mainContainer">
        <div class="calendar-container">
            <div class="header">
                <h1>üìÖ My Calendar</h1>
                <div class="header-buttons">
                    <button class="header-btn" onclick="openCategoriesModal('event')">‚öôÔ∏è Categories</button>
                    <button class="header-btn" onclick="openListsModal()">üìã Lists & Smart Add</button>
                    <button class="header-btn" onclick="openPrintModal()">üñ®Ô∏è Print</button>
                    <button class="header-btn" onclick="logout()">Logout</button>
                </div>
            </div>
            <div class="controls">
                <div class="month-nav" style="position:relative; z-index:20;">
                    <button onclick="previousMonth()">‚Üê Previous</button>
                    <div style="position:relative; display:inline-block;">
                        <h2 id="currentMonth" onclick="toggleMonthDropdown()"
                            style="cursor:pointer; user-select:none; margin:0 10px; display:inline-block;"
                            title="Click to jump to month"></h2>
                        <div id="monthDropdown" class="month-dropdown"></div>
                    </div>
                    <button onclick="nextMonth()">Next ‚Üí</button>
                </div>
                <button class="add-event-btn" onclick="openEventModal()">+ Add Event</button>
            </div>
            <div
                style="padding: 10px 20px; display: flex; align-items: center; gap: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                <span style="font-weight:bold; color:#666;">Filter Events:</span>
                <select id="eventFilter" onchange="filterCalendar()"
                    style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="all">Show All</option>
                </select>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="tasks-container">
            <div class="tasks-header">
                <h1>‚úÖ My Tasks</h1>
                <div class="header-buttons">
                    <button class="header-btn" onclick="openCategoriesModal('task')">‚öôÔ∏è Categories</button>
                    <button class="add-event-btn" onclick="openTaskModal()">+ Add Task</button>
                </div>
            </div>
            <div class="tasks-content" id="tasksContent"></div>
        </div>
    </div>

    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 id="modalTitle" style="margin:0">Add Event</h2>
                <button onclick="closeEventModal()"
                    style="padding:5px 10px; font-size:12px; background:#95a5a6; color:white; border:none; border-radius:4px; cursor:pointer;">CANCEL</button>
            </div>
            <div class="form-group"><label>Title</label><input type="text" id="eventTitle"
                    oninput="if(editingEventId===null)document.getElementById('eventDescription').value=this.value" />
            </div>
            <div class="form-group"><label>Date</label><input type="date" id="eventDate" /></div>
            <div class="form-group"><label>Time</label><input type="time" id="eventTime" /></div>
            <div class="form-group"><label>Duration (days)</label><input type="number" id="eventDuration" min="1"
                    value="1" /></div>
            <div class="form-group"><label>Description</label><textarea id="eventDescription"></textarea></div>
            <div class="form-group"><label>Category</label><select id="eventCategory"></select></div>
            <div class="form-group"><label>Icon</label>
                <div class="icon-selector" id="iconSelector"></div>
            </div>
            <div class="form-group"><label>Repeat</label>
                <div class="repeat-options" id="repeatOptions"></div>
            </div>
            <div class="button-group">
                <button class="save-btn" onclick="saveEvent()">Save</button>
                <button class="delete-btn" id="deleteEventBtn" onclick="deleteEvent()"
                    style="display:none;">Delete</button>
                <button class="cancel-btn" onclick="closeEventModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 id="taskModalTitle" style="margin:0">Add Task</h2>
                <button onclick="closeTaskModal()"
                    style="padding:5px 10px; font-size:12px; background:#95a5a6; color:white; border:none; border-radius:4px; cursor:pointer;">CANCEL</button>
            </div>
            <div class="form-group"><label>Title</label><input type="text" id="taskTitle"
                    oninput="if(editingTaskId===null)document.getElementById('taskDescription').value=this.value" />
            </div>
            <div class="form-group"><label>Description</label><textarea id="taskDescription"></textarea></div>
            <div class="form-group"><label>Category</label><select id="taskCategory"></select></div>
            <div class="form-group"><label>Icon</label>
                <div class="icon-selector" id="taskIconSelector"></div>
            </div>
            <div class="form-group"><label>Repeat</label>
                <div class="repeat-options" id="taskRepeatOptions"></div>
            </div>
            <div class="button-group">
                <button class="save-btn" onclick="saveTask()">Save</button>
                <button class="delete-btn" id="deleteTaskBtn" onclick="deleteTask()"
                    style="display:none;">Delete</button>
                <button class="cancel-btn" onclick="closeTaskModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="categoriesModal">
        <div class="modal-content">
            <h2 id="categoriesModalTitle">Manage Categories</h2>
            <div id="categoriesList"></div>
            <div class="add-category-section">
                <h3>Add New Category</h3>
                <div class="form-group"><label>Name</label><input type="text" id="newCategoryName" /></div>
                <div class="form-group"><label>Icon</label>
                    <div class="icon-selector" id="categoryIconSelector"></div>
                </div>
                <div class="form-group"><label>Color</label>
                    <div class="color-grid" id="colorGrid"></div>
                </div>
                <button class="save-btn" onclick="addCategory()" style="width:100%">Add</button>
            </div>
            <div class="button-group"><button class="cancel-btn" onclick="closeCategoriesModal()">Close</button></div>
        </div>
    </div>

    <div class="modal" id="editCategoryModal">
        <div class="modal-content">
            <h2>Edit Category</h2>
            <div class="form-group"><label>Name</label><input type="text" id="editCategoryName" /></div>
            <div class="form-group"><label>Icon</label>
                <div class="icon-selector" id="editCategoryIconSelector"></div>
            </div>
            <div class="form-group"><label>Color</label>
                <div class="color-grid" id="editColorGrid"></div>
            </div>
            <div class="button-group">
                <button class="save-btn" onclick="saveEditedCategory()">Save</button>
                <button class="cancel-btn" onclick="closeEditCategoryModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Lists Management Modal -->
    <div class="modal" id="listsModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>üìã Event Lists & Smart Add</h2>
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button class="header-btn" style="background:#667eea; flex:1;" onclick="openListDetailModal()">+ New
                    Custom List</button>
                <button class="header-btn" style="background:#e67e22; flex:1;" onclick="openSmartSearch()">üåê Smart
                    Online Search</button>
            </div>
            <div id="listsContainer" style="max-height: 400px; overflow-y: auto;">
                <!-- Lists will appear here -->
            </div>
            <div class="button-group">
                <button class="cancel-btn" onclick="closeListsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Smart Search Modal -->
    <div class="modal" id="smartSearchModal">
        <div class="modal-content">
            <h2>üåê Smart Schedule Search</h2>
            <p style="color:#666; margin-bottom:15px; font-size:14px;">Find public schedules (Schools, Sports, Holidays)
                and auto-add them.</p>
            <div class="form-group">
                <label>Search Query</label>
                <input type="text" id="smartSearchInput" placeholder="e.g., 'Wake County Schools', 'US Holidays'" />
            </div>
            <div id="smartSearchResults" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
            <div class="button-group">
                <button class="save-btn" onclick="performSmartSearch()">Search</button>
                <button class="cancel-btn" onclick="closeSmartSearch()">Close</button>
            </div>
        </div>
    </div>

    <!-- List Detail/Edit Modal -->
    <div class="modal" id="listDetailModal">
        <div class="modal-content">
            <h2 id="listDetailTitle">Edit List</h2>
            <div class="form-group"><label>List Name</label><input type="text" id="listName"
                    oninput="if(currentListId===null){document.getElementById('listDesc').value=this.value; document.getElementById('listEventTitle').value=this.value;}" />
            </div>
            <div class="form-group"><label>Description</label><textarea id="listDesc"></textarea></div>

            <h3>Events in this List</h3>
            <div id="listEventsContainer"
                style="background:#f8f9fa; padding:10px; border-radius:6px; max-height:200px; overflow-y:auto; margin-bottom:15px;">
                <p style="text-align:center; color:#999;">No events yet. Add one below.</p>
            </div>

            <div style="background:#eee; padding:10px; border-radius:6px;">
                <div class="form-group" style="margin-bottom:10px;"><input type="text" id="listEventTitle"
                        placeholder="Event Title" /></div>
                <div class="form-group"
                    style="margin-bottom:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="date" id="listEventDate" title="Specific Date (Optional)" />
                    <input type="time" id="listEventTime" />
                </div>
                <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-size:11px; color:#555;">Repeat</label>
                        <select id="listEventRepeat" style="width:100%;">
                            <option value="none">One Time</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:11px; color:#555;">End Date (Optional)</label>
                        <input type="date" id="listEventEndDate" style="width:100%;" />
                    </div>
                </div>
                <button class="save-btn" onclick="addEventToListDraft()" style="width:100%; padding:8px;">+ Add to
                    List</button>
            </div>

            <div class="button-group">
                <button class="save-btn" onclick="saveList()">Save List</button>
                <button class="cancel-btn" onclick="closeListDetailModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Print Container (Hidden on screen, visible on print) -->
    <div id="printContainer"></div>

    <!-- Print Options Modal -->
    <div class="modal" id="printModal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2>üñ®Ô∏è Print Calendar</h2>
            <p style="margin-bottom: 20px; color:#555;">Select range to view in Print Preview:</p>
            <div class="button-group" style="flex-direction: column; gap: 15px;">
                <button class="save-btn" onclick="printCalendar(1)" style="background:#667eea;">Current Month</button>
                <button class="save-btn" onclick="printCalendar(3)" style="background:#667eea;">Next 3 Months</button>
                <button class="save-btn" onclick="printCalendar(12)" style="background:#667eea;">Whole Year (12
                    Months)</button>
            </div>
            <div class="button-group">
                <button class="cancel-btn" onclick="closePrintModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>

        let currentDate = new Date();
        let events = {};
        let repeatingEvents = [];
        let tasks = [];
        let repeatingTasks = [];
        let eventLists = [];
        let eventCategories = {};
        let taskCategories = {};
        let currentEventFilter = 'all'; // New filter state

        // Draft variables for List Editing
        let currentListId = null;
        let draftListEvents = [];

        let editingEventId = null;
        let editingTaskId = null;
        let editingCategoryKey = null;
        let currentCategoryType = 'event';
        let selectedEventIcon = '';
        let selectedTaskIcon = '';
        let selectedCategoryIcon = '';
        let selectedColor = '';
        let selectedEditColor = '';
        let selectedEditIcon = '';
        let selectedRepeat = 'none';
        let selectedTaskRepeat = 'none';

        const ICONS = ['üéâ', 'üéÇ', 'üíº', 'üìÖ', '‚úàÔ∏è', 'üè•', 'üéì', 'üí™', 'üçΩÔ∏è', 'üéµ', 'üìö', 'üíª', 'üé®', '‚öΩ', 'üèÄ', 'ü§∏', 'üéÆ', 'üé¨', 'üìû', '‚úâÔ∏è', 'üè†', 'üöó', 'üéÅ', '‚ù§Ô∏è', '‚≠ê', 'üîî', 'üìù', 'üí°', 'üîß', 'üõí', '‚òï', 'üåü', 'üéØ', 'üìä', 'üßπ', 'üß∫', 'üßº', 'üßΩ', 'üß¥', 'üõÅ', 'üßª', 'üóëÔ∏è', 'üî®', 'ü™õ', 'ü™ö', 'üí∞', 'üíµ', 'üí≥', 'üßæ', 'üè¶', 'üí≤', 'ü§†', 'üêé', 'üêÇ', 'üèá', 'üåµ', 'üë¢'];
        const COLORS = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e91e63', '#795548', '#ff5722', '#00bcd4', '#4caf50', '#ffc107', '#673ab7', '#009688', '#ff4081', '#8d6e63', '#f44336', '#2196f3', '#8bc34a', '#ffeb3b', '#9c27b0', '#00acc1', '#ec407a', '#a1887f'];
        const REPEAT = [{ value: 'none', label: 'No Repeat' }, { value: 'daily', label: 'Every Day' }, { value: 'weekly', label: 'Every Week' }, { value: 'biweekly', label: 'Every 2 Weeks' }, { value: 'monthly', label: 'Every Month' }, { value: 'yearly', label: 'Every Year' }];

        function hash(p) {
            let h = 0;
            for (let i = 0; i < p.length; i++) {
                h = ((h << 5) - h) + p.charCodeAt(i);
                h &= h;
            }
            return h.toString();
        }

        function formatTime(t) {
            if (!t) return '';
            try {
                let parts = t.split(':');
                if (parts.length < 2) return t;
                let h = parseInt(parts[0]);
                let m = parts[1];
                if (isNaN(h)) return t;
                const ampm = h >= 12 ? 'PM' : 'AM';
                h = h % 12;
                h = h ? h : 12;
                return h + ':' + m + ' ' + ampm;
            } catch (e) {
                console.error("Time format error", e);
                return t;
            }
        }

        function login() {
            const p = document.getElementById('passwordInput').value,
                e = document.getElementById('errorMessage');
            if (!p) {
                e.textContent = 'Enter password';
                return;
            }
            const h = hash(p),
                s = localStorage.getItem('cal_pw');
            if (!s) {
                localStorage.setItem('cal_pw', h);
                init();
            } else if (s === h) {
                init();
            } else {
                e.textContent = 'Wrong password';
            }
        }

        function logout() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        }

        function init() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            load();
            renderCalendar();
            renderTasks();
        }

        function load() {
            events = JSON.parse(localStorage.getItem('events') || '{}');
            repeatingEvents = JSON.parse(localStorage.getItem('repEvents') || '[]');
            tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            repeatingTasks = JSON.parse(localStorage.getItem('repTasks') || '[]');
            eventLists = JSON.parse(localStorage.getItem('eventLists') || '[]');
            eventCategories = JSON.parse(localStorage.getItem('eCats') || '{"personal":{"name":"Personal","color":"#3498db","icon":"üë§"},"work":{"name":"Work","color":"#e74c3c","icon":"üíº"}}');
            taskCategories = JSON.parse(localStorage.getItem('tCats') || '{"cleaning":{"name":"Cleaning","color":"#3498db","icon":"üßπ"},"shopping":{"name":"Shopping","color":"#f39c12","icon":"üõí"}}');
            updateSelects(); // Updates modal selects
            updateFilterDropdown(); // New: Updates calendar filter
            renderLists();
        }

        function save() {
            localStorage.setItem('events', JSON.stringify(events));
            localStorage.setItem('repEvents', JSON.stringify(repeatingEvents));
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('repTasks', JSON.stringify(repeatingTasks));
            localStorage.setItem('eCats', JSON.stringify(eventCategories));
            localStorage.setItem('tCats', JSON.stringify(taskCategories));
            localStorage.setItem('eventLists', JSON.stringify(eventLists));
        }

        /* --- LISTS & SMART ADD LOGIC --- */

        function openListsModal() {
            document.getElementById('listsModal').style.display = 'flex';
            renderLists();
        }

        function closeListsModal() {
            document.getElementById('listsModal').style.display = 'none';
        }

        function renderLists() {
            const container = document.getElementById('listsContainer');
            container.innerHTML = '';
            if (eventLists.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No Custom Lists Created</div>';
                return;
            }
            eventLists.forEach(list => {
                const start = document.createElement('div');
                start.className = 'task-item'; // Reuse task style
                start.onclick = (e) => {
                    // If clicking buttons, don't open modal
                    if (e.target.tagName === 'BUTTON') return;
                    openListDetailModal(list.id);
                };
                start.style.cursor = 'pointer';
                start.innerHTML = `
                    <div class="task-icon">üìã</div>
                    <div class="task-details">
                        <div class="task-title" style="font-weight:bold;">${list.name}</div>
                        <div class="task-category">${list.events.length} events ‚Ä¢ ${list.description || 'No description'}</div>
                    </div>
                    <div class="task-actions">
                        <button style="background:#27ae60; color:white;" onclick="applyListToCalendar('${list.id}')">Apply</button>
                        <button style="background:#e74c3c; color:white;" onclick="deleteList('${list.id}')">Delete</button>
                    </div>
                `;
                container.appendChild(start);
            });
        }

        // --- Print Logic ---
        function openPrintModal() {
            document.getElementById('printModal').style.display = 'flex';
        }
        function closePrintModal() {
            document.getElementById('printModal').style.display = 'none';
        }

        function printCalendar(months) {
            const container = document.getElementById('printContainer');
            container.innerHTML = '';

            let printDate = new Date(currentDate);
            if (months === 12) {
                // For whole year, start from Jan of current year
                printDate = new Date(printDate.getFullYear(), 0, 1);
            }

            for (let i = 0; i < months; i++) {
                const y = printDate.getFullYear();
                const m = printDate.getMonth();

                const box = document.createElement('div');
                box.className = 'print-page';

                const monthName = printDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                box.innerHTML = `<div class="print-header">${monthName}</div>`;

                const grid = document.createElement('div');
                grid.className = 'print-grid';

                // Headers
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
                    const h = document.createElement('div');
                    h.className = 'print-day-header';
                    h.textContent = d;
                    grid.appendChild(h);
                });

                // Logic to generate days - similar to renderCalendar but returning HTML strings or nodes
                const first = new Date(y, m, 1);
                const last = new Date(y, m + 1, 0);
                const prev = new Date(y, m, 0);
                const start = first.getDay();
                const total = last.getDate();

                // Prev month filler
                for (let k = start - 1; k >= 0; k--) {
                    grid.appendChild(createPrintDay(prev.getDate() - k, y, m - 1, true));
                }
                // Current month
                for (let k = 1; k <= total; k++) {
                    grid.appendChild(createPrintDay(k, y, m, false));
                }
                // Next month filler
                const rem = 42 - (start + total);
                for (let k = 1; k <= rem; k++) {
                    grid.appendChild(createPrintDay(k, y, m + 1, true));
                }

                box.appendChild(grid);
                container.appendChild(box);

                // Increment Month
                printDate.setMonth(printDate.getMonth() + 1);
            }

            closePrintModal();
            setTimeout(() => window.print(), 300);
        }

        function createPrintDay(day, y, m, other) {
            const cell = document.createElement('div');
            cell.className = 'print-cell' + (other ? ' other-month' : '');

            const dk = `${y}-${String(m + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            let dateHtml = `<div class="print-date-num">${day}</div>`;
            cell.innerHTML = dateHtml;

            const all = [...(events[dk] || []), ...getRepEvents(dk)];
            all.forEach(e => {
                const div = document.createElement('div');
                div.className = 'print-event';
                // Inline color for print
                const color = eventCategories[e.category]?.color || '#999';
                div.style.cssText = `background-color: ${color} !important; -webkit-print-color-adjust: exact;`;

                let timeStr = e.time ? formatTime(e.time) : '';
                div.innerText = (e.icon || '') + ' ' + (timeStr ? timeStr + ' ' : '') + e.title;
                cell.appendChild(div);
            });
            return cell;
        }

        function applyListToCalendar(listId) {
            const list = eventLists.find(l => l.id === listId);
            if (!list) return;
            if (!confirm(`Apply "${list.name}" to your calendar?`)) return;

            let addCount = 0;
            let skipCount = 0;

            list.events.forEach(e => {
                // Handle Duration (Multi-day events)
                // Default to 1 day if not specified.
                const duration = e.duration || 1;

                for (let d = 0; d < duration; d++) {
                    // Calculate date for this iteration (StartDate + d days)
                    let baseDate = new Date(e.startDate);
                    baseDate.setDate(baseDate.getDate() + d + 1); // +1 because e.startDate "2025-08-25" parses to UTC midnight, often previous day in local if not careful, but splitting string is safer.

                    // BETTER DATE PARSING TO AVOID TIMEZONE ISSUES
                    let parts = e.startDate.split('-');
                    let dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                    dateObj.setDate(dateObj.getDate() + d);

                    let targetDateKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                    // If it's a repeating event, we handle differently
                    if (e.repeat && e.repeat !== 'none') {
                        // Check duplicate in rep events (simplified check)
                        const exists = repeatingEvents.some(re => re.title === e.title && re.startDate === e.startDate);
                        if (!exists) {
                            const newRepEvent = {
                                id: Date.now().toString() + Math.random().toString().substr(2, 5),
                                title: e.title,
                                time: e.time || '',
                                description: e.description || '',
                                category: Object.keys(eventCategories)[0],
                                icon: e.icon || '',
                                repeat: e.repeat,
                                startDate: e.startDate,
                                endDate: e.endDate || null // Pass End Date
                            };
                            repeatingEvents.push(newRepEvent);
                            addCount++;
                        } else {
                            skipCount++;
                        }
                        // Break loop for repeating events (don't support duration on repeating yet)
                        break;
                    } else {
                        // One-time event
                        if (!events[targetDateKey]) events[targetDateKey] = [];

                        // Check for duplicate on this specific day
                        const exists = events[targetDateKey].some(ev => ev.title === e.title);
                        if (!exists) {
                            const newEvent = {
                                id: Date.now().toString() + Math.random().toString().substr(2, 5),
                                title: e.title + (duration > 1 ? ` (Day ${d + 1}/${duration})` : ''),
                                time: e.time || '',
                                description: e.description || '',
                                category: Object.keys(eventCategories)[0],
                                icon: e.icon || '',
                                repeat: 'none'
                            };
                            events[targetDateKey].push(newEvent);
                            addCount++;
                        } else {
                            skipCount++;
                        }
                    }
                }
            });
            save();
            renderCalendar();
            alert(`Added ${addCount} events. (Skipped ${skipCount} duplicates). \n\nCheck specific months (like Jan/Mar 2026) to see them!`);
            closeListsModal();
        }

        function deleteList(listId) {
            if (!confirm("Delete this list?")) return;
            eventLists = eventLists.filter(l => l.id !== listId);
            save();
            renderLists();
        }

        // --- List Editor ---
        function openListDetailModal(listId = null) {
            currentListId = listId;
            const m = document.getElementById('listDetailModal');
            document.getElementById('listName').value = '';
            document.getElementById('listDesc').value = '';
            draftListEvents = [];

            if (listId) {
                // Edit existing logic would go here
            } else {
                document.getElementById('listDetailTitle').innerText = 'Create New List';
            }
            renderDraftEvents();
            m.style.display = 'flex';
        }

        function closeListDetailModal() {
            document.getElementById('listDetailModal').style.display = 'none';
        }

        function addEventToListDraft() {
            const t = document.getElementById('listEventTitle').value;
            const d = document.getElementById('listEventDate').value; // Optional
            const tm = document.getElementById('listEventTime').value;
            const r = document.getElementById('listEventRepeat').value;
            const ed = document.getElementById('listEventEndDate').value; // Optional

            if (!t) return alert("Title required");

            draftListEvents.push({
                title: t,
                startDate: d, // empty string if not set, handled in apply
                time: tm,
                repeat: r,
                endDate: ed
            });

            // reset inputs
            document.getElementById('listEventTitle').value = '';
            document.getElementById('listEventTime').value = '';
            document.getElementById('listEventDate').value = '';
            document.getElementById('listEventEndDate').value = '';
            document.getElementById('listEventRepeat').value = 'none';

            renderDraftEvents();
        }

        function renderDraftEvents() {
            const c = document.getElementById('listEventsContainer');
            c.innerHTML = '';
            if (draftListEvents.length === 0) {
                c.innerHTML = '<p style="text-align:center; color:#999; padding:10px;">No events added yet.</p>';
                return;
            }
            draftListEvents.forEach((e, idx) => {
                const d = document.createElement('div');
                d.style.cssText = "background:white; margin:5px 0; padding:8px; border-radius:4px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer;";

                // Construct Hover String
                let hoverText = `${e.title}`;
                if (e.repeat !== 'none') {
                    hoverText += ` - ${e.repeat.charAt(0).toUpperCase() + e.repeat.slice(1)}`;
                    if (e.time) hoverText += ` at ${formatTime(e.time)}`;
                    hoverText += ` until ${e.endDate ? e.endDate : 'No End Date'}`;
                } else {
                    if (e.startDate) hoverText += ` on ${e.startDate}`;
                    if (e.time) hoverText += ` at ${formatTime(e.time)}`;
                }
                d.title = hoverText;

                d.onclick = () => {
                    // EDIT MODE: Populate fields
                    if (confirm("Edit this item? It will be removed from the list and put back in the form.")) {
                        document.getElementById('listEventTitle').value = e.title;
                        document.getElementById('listEventDate').value = e.startDate || '';
                        document.getElementById('listEventTime').value = e.time || '';
                        document.getElementById('listEventRepeat').value = e.repeat;
                        document.getElementById('listEventEndDate').value = e.endDate || '';

                        // Remove from list so user can save updated version
                        draftListEvents.splice(idx, 1);
                        renderDraftEvents();
                    }
                };

                d.innerHTML = `<span>${e.title} <small style='color:#666'>(${e.repeat})</small></span> <button onclick="event.stopPropagation(); draftListEvents.splice(${idx},1);renderDraftEvents()" style="color:red;border:none;background:none;cursor:pointer;font-weight:bold;">X</button>`;
                c.appendChild(d);
            });
        }

        function saveList() {
            const name = document.getElementById('listName').value;
            const desc = document.getElementById('listDesc').value;
            if (!name) return alert("List name required");
            if (draftListEvents.length === 0) return alert("Add at least one event");

            const newList = {
                id: Date.now().toString(),
                name: name,
                description: desc,
                events: draftListEvents
            };
            eventLists.push(newList);
            save();
            closeListDetailModal();
            renderLists();
        }

        // --- Smart Search ---
        function openSmartSearch() {
            document.getElementById('listsModal').style.display = 'none';
            document.getElementById('smartSearchModal').style.display = 'flex';
            document.getElementById('smartSearchResults').innerHTML = '';
            document.getElementById('smartSearchInput').value = '';
        }
        function closeSmartSearch() {
            document.getElementById('smartSearchModal').style.display = 'none';
            document.getElementById('listsModal').style.display = 'flex';
        }

        function performSmartSearch() {
            const q = document.getElementById('smartSearchInput').value.toLowerCase();
            const res = document.getElementById('smartSearchResults');
            res.innerHTML = '<div style="text-align:center;">Searching public databases... üåê</div>';

            setTimeout(() => {
                let hits = [];
                // Simulated "Online" database
                if (q.includes('school')) {
                    // 2025-2026 (Current Academic Year)
                    hits.push({
                        name: 'Wake County Public Schools 2025-26',
                        desc: 'Current Year: Includes Spring 2026 dates',
                        events: [
                            { title: 'First Day of School', startDate: '2025-08-25', repeat: 'none', icon: 'üè´' },
                            { title: 'Winter Break', startDate: '2025-12-22', duration: 12, repeat: 'none', icon: '‚ùÑÔ∏è' },
                            { title: 'Martin Luther King Jr. Day', startDate: '2026-01-19', repeat: 'none', icon: '‚úä' },
                            { title: 'Teacher Workday', startDate: '2026-02-20', repeat: 'none', icon: 'üë©‚Äçüè´' },
                            { title: 'Spring Break', startDate: '2026-03-30', duration: 5, repeat: 'none', icon: 'üå±' },
                            { title: 'Memorial Day', startDate: '2026-05-25', repeat: 'none', icon: 'üá∫üá∏' },
                            { title: 'Last Day of School', startDate: '2026-06-12', repeat: 'none', icon: 'üéâ' }
                        ]
                    });

                    // 2026-2027 (Next Academic Year)
                    hits.push({
                        name: 'Wake County Public Schools 2026-27',
                        desc: 'Next Year: Fall 2026 dates',
                        events: [
                            { title: 'First Day of School', startDate: '2026-08-24', repeat: 'none', icon: 'üè´' },
                            { title: 'Labor Day (No School)', startDate: '2026-09-07', repeat: 'none', icon: 'üö´' },
                            { title: 'Teacher Workday', startDate: '2026-10-30', repeat: 'none', icon: 'üë©‚Äçüè´' },
                            { title: 'Winter Break', startDate: '2026-12-21', duration: 10, repeat: 'none', icon: '‚ùÑÔ∏è' },
                        ]
                    });
                }
                if (q.includes('holiday') || q.includes('us')) {
                    hits.push({
                        name: 'US Federal Holidays 2026',
                        desc: 'Major standard holidays',
                        events: [
                            { title: 'New Year Day', startDate: '2026-01-01', repeat: 'yearly', icon: 'üéÜ' },
                            { title: 'Independence Day', startDate: '2026-07-04', repeat: 'yearly', icon: 'üá∫üá∏' },
                            { title: 'Thanksgiving', startDate: '2026-11-26', repeat: 'none', icon: 'ü¶É' },
                            { title: 'Christmas', startDate: '2026-12-25', repeat: 'yearly', icon: 'üéÑ' }
                        ]
                    });
                }
                // Default fallback to show capability
                if (hits.length === 0) {
                    hits.push({
                        name: 'Sample: Gymnastics Schedule',
                        desc: 'Example schedule for 2026 Season',
                        events: [
                            { title: 'Gymnastics Practice', startDate: '2026-02-01', repeat: 'weekly', time: '16:00', icon: 'ü§∏' },
                            { title: 'Regional Meet', startDate: '2026-03-15', repeat: 'none', icon: 'üèÜ' }
                        ]
                    });
                }

                res.innerHTML = '';
                hits.forEach(h => {
                    const d = document.createElement('div');
                    d.style.cssText = "padding:10px; border:1px solid #eee; margin-bottom:10px; border-radius:6px; cursor:pointer; hover:background:#f9f9f9;";
                    d.innerHTML = `<strong>${h.name}</strong><br><small>${h.desc}</small>`;
                    d.onclick = () => {
                        eventLists.push({
                            id: Date.now().toString(),
                            name: h.name,
                            description: h.desc,
                            events: h.events
                        });
                        save();
                        alert("Imported " + h.name + " to your Lists!");
                        closeSmartSearch();
                        renderLists();
                    };
                    res.appendChild(d);
                });

            }, 1000);
        }



        function getRepEvents(dk) {
            const d = new Date(dk),
                arr = [];
            repeatingEvents.forEach(e => {
                const ed = new Date(e.startDate);
                if (d < ed) return;

                // End Date Check
                if (e.endDate) {
                    const stopDate = new Date(e.endDate);
                    if (d > stopDate) return;
                }

                let show = false;
                switch (e.repeat) {
                    case 'daily':
                        show = true;
                        break;
                    case 'weekly':
                        show = d.getDay() === ed.getDay();
                        break;
                    case 'biweekly':
                        const diff = Math.floor((d - ed) / (864e5));
                        show = d.getDay() === ed.getDay() && diff % 14 === 0;
                        break;
                    case 'monthly':
                        show = d.getDate() === ed.getDate();
                        break;
                    case 'yearly':
                        show = d.getDate() === ed.getDate() && d.getMonth() === ed.getMonth();
                        break;
                }
                if (show) arr.push({
                    ...e,
                    isRepeating: true
                });
            });
            return arr;
        }

        function getRepTasks() {
            const t = new Date(),
                tk = `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}-${String(t.getDate()).padStart(2, '0')}`,
                arr = [];
            repeatingTasks.forEach(task => {
                if (!task.startDate) return;
                const td = new Date(task.startDate),
                    today = new Date(tk);
                if (today < td) return;
                let show = false;
                switch (task.repeat) {
                    case 'daily':
                        show = true;
                        break;
                    case 'weekly':
                        show = today.getDay() === td.getDay();
                        break;
                    case 'biweekly':
                        const diff = Math.floor((today - td) / (864e5));
                        show = today.getDay() === td.getDay() && diff % 14 === 0;
                        break;
                    case 'monthly':
                        show = today.getDate() === td.getDate();
                        break;
                    case 'yearly':
                        show = today.getDate() === td.getDate() && today.getMonth() === td.getMonth();
                        break;
                }
                if (show) {
                    const done = task.completedDates && task.completedDates.includes(tk);
                    arr.push({
                        ...task,
                        isRepeating: true,
                        completed: done,
                        currentDate: tk
                    });
                }
            });
            return arr;
        }

        // Click Debounce Timer
        let clickTimer = null;

        // --- Move / Drag Logic ---

        function handleDrop(e, newDate) {
            e.preventDefault();
            e.target.style.background = ''; // reset drag visual
            try {
                const data = JSON.parse(e.dataTransfer.getData("text/plain"));
                if (data.id && data.oldDate !== newDate) {
                    executeMove(data.id, data.oldDate, newDate, data.title, data.isRepeating);
                }
            } catch (err) { console.error('Drop error', err); }
        }

        function promptMoveEvent(id, oldDate, isRepeating) {
            let ev = null;
            if (isRepeating) ev = repeatingEvents.find(e => e.id === id);
            else if (events[oldDate]) ev = events[oldDate].find(e => e.id === id);

            if (!ev) return;

            const newDate = prompt("Move event to date (YYYY-MM-DD):", oldDate);
            if (newDate && newDate !== oldDate) {
                if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) return alert("Invalid date format. Use YYYY-MM-DD");
                executeMove(id, oldDate, newDate, ev.title, isRepeating);
            }
        }

        function executeMove(id, oldDate, newDate, title, isRepeating) {
            // Check for Series "(Day X/Y)"
            const seriesMatch = title.match(/(.*) \(Day (\d+)\/(\d+)\)/);

            if (!isRepeating && seriesMatch) {
                // It's a multi-day series part
                if (confirm("This is part of a multi-day series. Move the entire series?")) {
                    moveSeries(seriesMatch[1], seriesMatch[2], seriesMatch[3], oldDate, newDate);
                    return;
                }
            }

            // Normal Move
            if (isRepeating) {
                if (!confirm("Move this repeating event? This will change the start date for the pattern.")) return;
                const re = repeatingEvents.find(e => e.id === id);
                if (re) {
                    re.startDate = newDate;
                    save();
                    renderCalendar();
                }
            } else {
                // One Time
                if (events[oldDate]) {
                    const idx = events[oldDate].findIndex(e => e.id === id);
                    if (idx !== -1) {
                        const evt = events[oldDate].splice(idx, 1)[0];
                        if (events[oldDate].length === 0) delete events[oldDate];

                        if (!events[newDate]) events[newDate] = [];
                        events[newDate].push(evt);
                        save();
                        renderCalendar();
                    }
                }
            }
        }

        function moveSeries(coreTitle, currentStep, totalSteps, oldDateStr, newDateStr) {
            const currentIdx = parseInt(currentStep);
            const total = parseInt(totalSteps);

            // Calculate Day Diff
            const d1 = new Date(oldDateStr);
            const d2 = new Date(newDateStr);
            const diffTime = d2 - d1;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let count = 0;

            for (let i = 1; i <= total; i++) {
                // Expected Old Date
                let checkDate = new Date(d1);
                checkDate.setDate(checkDate.getDate() - (currentIdx - i));

                // Format YYYY-MM-DD
                let cdKey = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;

                // Expected Title
                let searchTitle = `${coreTitle} (Day ${i}/${total})`;

                if (events[cdKey]) {
                    const foundIdx = events[cdKey].findIndex(e => e.title === searchTitle);
                    if (foundIdx !== -1) {
                        // Move it
                        const evt = events[cdKey].splice(foundIdx, 1)[0];
                        if (events[cdKey].length === 0) delete events[cdKey];

                        // New Date for this item
                        let targetDate = new Date(checkDate);
                        targetDate.setDate(targetDate.getDate() + diffDays);
                        let tdKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;

                        if (!events[tdKey]) events[tdKey] = [];
                        events[tdKey].push(evt);
                        count++;
                    }
                }
            }
            save();
            renderCalendar();
            alert(`Moved ${count} days of the '${coreTitle}' series.`);
        }

        function renderCalendar() {
            const y = currentDate.getFullYear(),
                m = currentDate.getMonth();

            // Header with Dropdown Arrow
            const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonth').innerHTML = `${monthName} <span style="font-size:12px; vertical-align:middle; opacity:0.5;">‚ñº</span>`;

            renderMonthDropdown(); // Populate dropdown

            const first = new Date(y, m, 1),
                last = new Date(y, m + 1, 0),
                prev = new Date(y, m, 0),
                start = first.getDay(),
                total = last.getDate(),
                grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
                const h = document.createElement('div');
                h.className = 'day-header';
                h.textContent = d;
                grid.appendChild(h);
            });
            for (let i = start - 1; i >= 0; i--) {
                grid.appendChild(createDay(prev.getDate() - i, y, m - 1, true));
            }
            for (let d = 1; d <= total; d++) {
                grid.appendChild(createDay(d, y, m, false));
            }
            const rem = 42 - (start + total);
            for (let d = 1; d <= rem; d++) {
                grid.appendChild(createDay(d, y, m + 1, true));
            }
        }

        // --- Month Navigation Logic ---
        function renderMonthDropdown() {
            const d = document.getElementById('monthDropdown');
            d.innerHTML = '';
            const year = currentDate.getFullYear();
            for (let i = 0; i < 12; i++) {
                const date = new Date(year, i, 1);
                const mName = date.toLocaleString('default', { month: 'long' });
                const item = document.createElement('div');
                item.className = 'month-option';
                if (i === currentDate.getMonth()) item.classList.add('current');
                item.textContent = mName + ' ' + year;
                item.onclick = (e) => {
                    e.stopPropagation();
                    currentDate.setMonth(i);
                    // Handle year boundary safety if moving Dec -> Jan etc, but here we set explicit month in current year context
                    // Actually setMonth wraps years if > 11, but 'i' is 0-11, so it stays in year potentially?
                    // Safe approach: set Full Year and Month
                    currentDate.setFullYear(year);
                    currentDate.setMonth(i);
                    renderCalendar();
                    toggleMonthDropdown();
                };
                d.appendChild(item);
            }
        }

        function toggleMonthDropdown() {
            const d = document.getElementById('monthDropdown');
            if (d.style.display === 'block') d.style.display = 'none';
            else d.style.display = 'block';
        }

        // Close dropdown when clicking elsewhere
        window.addEventListener('click', (e) => {
            const d = document.getElementById('monthDropdown');
            const t = document.getElementById('currentMonth');
            if (d.style.display === 'block' && e.target !== d && e.target !== t && !t.contains(e.target)) {
                d.style.display = 'none';
            }
        });

        function createDay(day, y, m, other) {
            const cell = document.createElement('div');
            cell.className = 'day-cell' + (other ? ' other-month' : '');

            // DROP ZONES
            cell.ondragover = (e) => { e.preventDefault(); cell.style.background = '#f0f0f0'; };
            cell.ondragleave = (e) => { cell.style.background = ''; };
            const dk = `${y}-${String(m + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            cell.ondrop = (e) => handleDrop(e, dk);

            const num = document.createElement('div');
            num.className = 'day-number';
            num.textContent = day;
            cell.appendChild(num);

            const all = [...(events[dk] || []), ...getRepEvents(dk)];

            all.forEach(e => {
                // FILTER CHECK
                if (currentEventFilter !== 'all' && e.category !== currentEventFilter) return;

                const el = document.createElement('div');
                el.className = 'event-item' + (e.isRepeating ? ' repeating' : '');
                el.style.backgroundColor = eventCategories[e.category]?.color || '#999';
                el.draggable = true; // ENABLE DRAG

                // DRAG START
                el.ondragstart = (ev) => {
                    ev.dataTransfer.setData("text/plain", JSON.stringify({
                        id: e.id,
                        oldDate: dk,
                        title: e.title,
                        isRepeating: e.isRepeating || false,
                        repeatType: e.repeat
                    }));
                };

                const ic = e.icon || eventCategories[e.category]?.icon || '';
                if (ic) {
                    const sp = document.createElement('span');
                    sp.textContent = ic;
                    el.appendChild(sp);
                }
                const txt = document.createElement('span');
                // USE FORMAT TIME HERE
                let displayTime = e.time ? formatTime(e.time) : '';
                txt.textContent = displayTime ? (displayTime + ' ' + e.title) : e.title;
                el.appendChild(txt);

                // TOOLTIP
                if (e.description) {
                    const tt = document.createElement('div');
                    tt.className = 'event-tooltip';
                    tt.textContent = e.description;
                    el.appendChild(tt);
                }

                // CLICK (Edit) vs DOUBLE CLICK (Move)
                el.onclick = ev => {
                    ev.stopPropagation();
                    if (clickTimer) clearTimeout(clickTimer);
                    clickTimer = setTimeout(() => {
                        openEventModal(e.id, dk, e.isRepeating);
                    }, 250);
                };
                el.ondblclick = ev => {
                    ev.stopPropagation();
                    if (clickTimer) clearTimeout(clickTimer);
                    promptMoveEvent(e.id, dk, e.isRepeating);
                };

                cell.appendChild(el);
            });
            if (!other) cell.onclick = () => openEventModal(null, dk);
            return cell;
        }

        // --- Filter Logic ---
        function updateFilterDropdown() {
            const s = document.getElementById('eventFilter');
            // Keep selected if possible
            const oldVal = s.value;
            s.innerHTML = '<option value="all">Show All</option>';
            for (let k in eventCategories) {
                const op = document.createElement('option');
                op.value = k;
                op.textContent = (eventCategories[k].icon || '') + ' ' + eventCategories[k].name;
                s.appendChild(op);
            }
            if (eventCategories[oldVal] || oldVal === 'all') s.value = oldVal;
            else s.value = 'all';
        }

        function filterCalendar() {
            currentEventFilter = document.getElementById('eventFilter').value;
            renderCalendar();
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function renderRep(id) {
            const c = document.getElementById(id);
            c.innerHTML = '';
            REPEAT.forEach(r => {
                const o = document.createElement('div');
                o.className = 'repeat-option';
                if (r.value === (id.includes('task') ? selectedTaskRepeat : selectedRepeat)) o.classList.add('selected');
                o.textContent = r.label;
                o.onclick = () => {
                    c.querySelectorAll('.repeat-option').forEach(e => e.classList.remove('selected'));
                    o.classList.add('selected');
                    if (id.includes('task')) selectedTaskRepeat = r.value;
                    else selectedRepeat = r.value;
                };
                c.appendChild(o);
            });
        }

        function renderIcons(id, getSel, setSel) {
            const c = document.getElementById(id);
            const render = () => {
                const currentSel = getSel() || '';
                c.innerHTML = '';
                ICONS.forEach(ic => {
                    const o = document.createElement('div');
                    o.className = 'icon-option';
                    if (currentSel.includes(ic)) o.classList.add('selected');
                    o.textContent = ic;
                    o.onclick = (e) => {
                        let newSel = currentSel;
                        if (e.shiftKey) {
                            if (newSel.includes(ic)) newSel = newSel.replace(ic, '');
                            else newSel += ic;
                        } else {
                            newSel = ic;
                        }
                        setSel(newSel);
                        render();
                    };
                    c.appendChild(o);
                });
            };
            render();
        }

        function renderColors(id, sel, cb) {
            const c = document.getElementById(id);
            c.innerHTML = '';
            COLORS.forEach(col => {
                const s = document.createElement('div');
                s.className = 'color-swatch';
                if (col === sel) s.classList.add('selected');
                s.style.backgroundColor = col;
                s.onclick = () => {
                    c.querySelectorAll('.color-swatch').forEach(e => e.classList.remove('selected'));
                    s.classList.add('selected');
                    cb(col);
                };
                c.appendChild(s);
            });
        }

        function openEventModal(id = null, dk = null, rep = false) {
            editingEventId = id;
            const m = document.getElementById('eventModal'),
                db = document.getElementById('deleteEventBtn');
            if (id) {
                document.getElementById('modalTitle').textContent = 'Edit Event';
                db.style.display = 'block';
                let ev = null;
                if (rep) ev = repeatingEvents.find(e => e.id === id);
                else {
                    for (let d in events) {
                        ev = events[d].find(e => e.id === id);
                        if (ev) {
                            dk = d;
                            break;
                        }
                    }
                }
                if (ev) {
                    document.getElementById('eventTitle').value = ev.title;
                    // For the input type="date", we must use YYYY-MM-DD
                    document.getElementById('eventDate').value = rep ? ev.startDate : dk;
                    // For input type="time", we MUST use military time (HH:MM). 
                    // HTML5 time inputs do not accept 12-hour format values.
                    document.getElementById('eventTime').value = ev.time || '';
                    document.getElementById('eventDescription').value = ev.description || '';
                    document.getElementById('eventCategory').value = ev.category;
                    selectedEventIcon = ev.icon || '';
                    selectedRepeat = ev.repeat || 'none';
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Add Event';
                db.style.display = 'none';
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventDate').value = dk || '';
                document.getElementById('eventTime').value = '';
                document.getElementById('eventDescription').value = '';
                document.getElementById('eventCategory').value = Object.keys(eventCategories)[0];
                document.getElementById('eventDuration').value = '1';
                selectedEventIcon = '';
                selectedRepeat = 'none';
            }
            renderIcons('iconSelector', () => selectedEventIcon, ic => selectedEventIcon = ic);
            renderRep('repeatOptions');
            m.style.display = 'flex';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
            editingEventId = null;
            selectedEventIcon = '';
            selectedRepeat = 'none';
        }

        function saveEvent() {
            const t = document.getElementById('eventTitle').value.trim(),
                d = document.getElementById('eventDate').value,
                tm = document.getElementById('eventTime').value,
                desc = document.getElementById('eventDescription').value.trim(),
                cat = document.getElementById('eventCategory').value;

            if (!t || !d) {
                alert('Enter title and date');
                return;
            }

            // CLEANUP OLD EVENT (AND SERIES IF APPLICABLE)
            if (editingEventId) {
                let oldEvent = null;
                // Find old event to check for series
                for (let dk in events) {
                    const found = events[dk].find(e => e.id === editingEventId);
                    if (found) { oldEvent = found; break; }
                }

                const seriesMatch = oldEvent ? oldEvent.title.match(/(.*) \(Day (\d+)\/(\d+)\)/) : null;

                if (seriesMatch && confirm("This event is part of a series. Update the entire series length/details?")) {
                    const coreTitle = seriesMatch[1];
                    const total = parseInt(seriesMatch[3]);

                    // DELETE ALL IN SERIES
                    for (let i = 1; i <= total; i++) {
                        const sTitle = `${coreTitle} (Day ${i}/${total})`;
                        for (let dk in events) {
                            const idx = events[dk].findIndex(e => e.title === sTitle);
                            if (idx !== -1) {
                                events[dk].splice(idx, 1);
                                if (events[dk].length === 0) delete events[dk];
                            }
                        }
                    }
                } else {
                    // Standard single delete (if user said No or not a series)
                    for (let dk in events) {
                        const i = events[dk].findIndex(e => e.id === editingEventId);
                        if (i !== -1) {
                            events[dk].splice(i, 1);
                            if (!events[dk].length) delete events[dk];
                            break;
                        }
                    }
                }

                const ri = repeatingEvents.findIndex(e => e.id === editingEventId);
                if (ri !== -1) repeatingEvents.splice(ri, 1);
            }

            // CHECK FOR SERIES UPDATE
            // If editing an event that looks like "Title (Day X/Y)", we might need to clear the whole old series
            let seriesTitleBase = null;
            if (editingEventId) {
                // We don't have the OLD title easily here unless we looked it up before delete.
                // But generally users will edit the 'Day 1' or any day. 
                // For V1 simplicity: We rely on the NEW Duration. 
                // If the user changes Duration on an event that WAS part of a series, we need to handle cleanup.

                // Currently 'saveEvent' deletes the single ID above.
                // If the user wants to resize a series, they should ideally start from Day 1 or we need advanced logic.
                // IMPROVEMENT: Detecting series from the title being saved (if user kept the name).
            }

            // Logic for Duration Resizing
            // If the user enters a Duration > 1, we generate the series.
            // If the user is editing an event and changes duration to 1, we only save the one.
            // However, the *other* days of the old series remain unless deleted.
            // FEATURE: Explicitly ask if resizing series.

            const ev = {
                id: editingEventId || Date.now().toString(),
                title: t,
                time: tm,
                description: desc,
                category: cat,
                icon: selectedEventIcon,
                repeat: selectedRepeat
            };
            if (selectedRepeat === 'none') {
                const duration = parseInt(document.getElementById('eventDuration').value) || 1;

                for (let i = 0; i < duration; i++) {
                    let dateObj = new Date(d + 'T00:00:00'); // Force local midnight
                    dateObj.setDate(dateObj.getDate() + i);
                    let targetDK = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                    // Clone event for this day
                    const dayEv = { ...ev };
                    dayEv.id = ev.id + (i > 0 ? '_' + i : ''); // Unique ID for sub-events
                    if (duration > 1) {
                        dayEv.title = `${t} (Day ${i + 1}/${duration})`;
                    }

                    if (!events[targetDK]) events[targetDK] = [];
                    events[targetDK].push(dayEv);
                }
            } else {
                ev.startDate = d;
                repeatingEvents.push(ev);
            }
            save();
            renderCalendar();
            closeEventModal();
        }

        function deleteEvent() {
            if (!confirm('Delete event?')) return;
            for (let dk in events) {
                const i = events[dk].findIndex(e => e.id === editingEventId);
                if (i !== -1) {
                    events[dk].splice(i, 1);
                    if (!events[dk].length) delete events[dk];
                    break;
                }
            }
            const ri = repeatingEvents.findIndex(e => e.id === editingEventId);
            if (ri !== -1) repeatingEvents.splice(ri, 1);
            save();
            renderCalendar();
            closeEventModal();
        }

        function renderTasks() {
            const c = document.getElementById('tasksContent');
            c.innerHTML = '';
            const all = [...tasks, ...getRepTasks()];
            if (!all.length) {
                c.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No tasks</p>';
                return;
            }
            const act = all.filter(t => !t.completed),
                done = all.filter(t => t.completed);
            [...act, ...done].forEach(t => {
                const el = document.createElement('div');
                el.className = 'task-item';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'task-checkbox';
                cb.checked = t.completed;
                cb.onchange = () => toggleTask(t.id, t.isRepeating, t.currentDate);
                const ic = document.createElement('span');
                ic.className = 'task-icon';
                ic.textContent = t.icon || taskCategories[t.category]?.icon || 'üìù';
                const det = document.createElement('div');
                det.className = 'task-details';
                const tit = document.createElement('div');
                tit.className = 'task-title' + (t.completed ? ' completed' : '');
                tit.textContent = t.title + (t.isRepeating ? ' üîÅ' : '');
                const cat = document.createElement('div');
                cat.className = 'task-category';
                cat.textContent = taskCategories[t.category]?.name || 'Other';
                cat.style.color = taskCategories[t.category]?.color || '#999';
                det.appendChild(tit);
                det.appendChild(cat);
                const acts = document.createElement('div');
                acts.className = 'task-actions';
                const eb = document.createElement('button');
                eb.textContent = 'Edit';
                eb.style.background = '#3498db';
                eb.style.color = 'white';
                eb.onclick = () => openTaskModal(t.id, t.isRepeating);
                const db = document.createElement('button');
                db.textContent = 'Delete';
                db.style.background = '#e74c3c';
                db.style.color = 'white';
                db.onclick = () => deleteTask(t.id, t.isRepeating);
                acts.appendChild(eb);
                acts.appendChild(db);
                el.appendChild(cb);
                el.appendChild(ic);
                el.appendChild(det);
                el.appendChild(acts);
                c.appendChild(el);
            });
        }

        function openTaskModal(id = null, rep = false) {
            editingTaskId = id;
            const m = document.getElementById('taskModal'),
                db = document.getElementById('deleteTaskBtn');
            if (id) {
                document.getElementById('taskModalTitle').textContent = 'Edit Task';
                db.style.display = 'block';
                let t = null;
                if (rep) t = repeatingTasks.find(tk => tk.id === id);
                else t = tasks.find(tk => tk.id === id);
                if (t) {
                    document.getElementById('taskTitle').value = t.title;
                    document.getElementById('taskDescription').value = t.description || '';
                    document.getElementById('taskCategory').value = t.category;
                    selectedTaskIcon = t.icon || '';
                    selectedTaskRepeat = t.repeat || 'none';
                }
            } else {
                document.getElementById('taskModalTitle').textContent = 'Add Task';
                db.style.display = 'none';
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskCategory').value = Object.keys(taskCategories)[0];
                selectedTaskIcon = '';
                selectedTaskRepeat = 'none';
            }
            renderIcons('taskIconSelector', () => selectedTaskIcon, ic => selectedTaskIcon = ic);
            renderRep('taskRepeatOptions');
            m.style.display = 'flex';
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            editingTaskId = null;
            selectedTaskIcon = '';
            selectedTaskRepeat = 'none';
        }

        function saveTask() {
            const t = document.getElementById('taskTitle').value.trim(),
                desc = document.getElementById('taskDescription').value.trim(),
                cat = document.getElementById('taskCategory').value;
            if (!t) {
                alert('Enter title');
                return;
            }
            if (editingTaskId) {
                const i = tasks.findIndex(tk => tk.id === editingTaskId);
                if (i !== -1) tasks.splice(i, 1);
                const ri = repeatingTasks.findIndex(tk => tk.id === editingTaskId);
                if (ri !== -1) repeatingTasks.splice(ri, 1);
            }
            const tk = {
                id: editingTaskId || Date.now().toString(),
                title: t,
                description: desc,
                category: cat,
                icon: selectedTaskIcon,
                repeat: selectedTaskRepeat,
                completed: false,
                startDate: new Date().toISOString().split('T')[0]
            };
            if (selectedTaskRepeat === 'none') tasks.push(tk);
            else repeatingTasks.push(tk);
            save();
            renderTasks();
            closeTaskModal();
        }

        function deleteTask() {
            if (!confirm('Delete task?')) return;
            const i = tasks.findIndex(tk => tk.id === editingTaskId);
            if (i !== -1) tasks.splice(i, 1);
            const ri = repeatingTasks.findIndex(tk => tk.id === editingTaskId);
            if (ri !== -1) repeatingTasks.splice(ri, 1);
            save();
            renderTasks();
            closeTaskModal();
        }

        function toggleTask(id, rep, curDate) {
            if (rep) {
                const t = repeatingTasks.find(tk => tk.id === id);
                if (t) {
                    if (!t.completedDates) t.completedDates = [];
                    if (t.completedDates.includes(curDate)) t.completedDates = t.completedDates.filter(d => d !== curDate);
                    else t.completedDates.push(curDate);
                }
            } else {
                const t = tasks.find(tk => tk.id === id);
                if (t) t.completed = !t.completed;
            }
            save();
            renderTasks();
        }

        function updateSelects() {
            const ec = document.getElementById('eventCategory'),
                tc = document.getElementById('taskCategory');
            ec.innerHTML = '';
            tc.innerHTML = '';
            for (let k in eventCategories) {
                const op = document.createElement('option');
                op.value = k;
                op.textContent = eventCategories[k].name;
                ec.appendChild(op);
            }
            for (let k in taskCategories) {
                const op = document.createElement('option');
                op.value = k;
                op.textContent = taskCategories[k].name;
                tc.appendChild(op);
            }
        }

        function openCategoriesModal(type) {
            currentCategoryType = type;
            const m = document.getElementById('categoriesModal');
            document.getElementById('categoriesModalTitle').textContent = type === 'event' ? 'Manage Event Categories' : 'Manage Task Categories';
            renderCategoriesList();
            renderIcons('categoryIconSelector', () => selectedCategoryIcon, ic => selectedCategoryIcon = ic);
            renderColors('colorGrid', selectedColor, c => selectedColor = c);
            m.style.display = 'flex';
        }

        function closeCategoriesModal() {
            document.getElementById('categoriesModal').style.display = 'none';
        }

        function renderCategoriesList() {
            const l = document.getElementById('categoriesList');
            l.innerHTML = '';
            const cats = currentCategoryType === 'event' ? eventCategories : taskCategories;
            for (let k in cats) {
                const c = cats[k];
                const d = document.createElement('div');
                d.className = 'category-item';
                d.innerHTML = `<div class="category-color" style="background:${c.color}"></div><div class="category-info"><div class="category-name">${c.icon || ''} ${c.name}</div></div><div class="category-actions"><button class="remove-category" onclick="deleteCategory('${k}')">Remove</button></div>`;
                l.appendChild(d);
            }
        }

        function addCategory() {
            const n = document.getElementById('newCategoryName').value.trim();
            if (!n || !selectedColor) {
                alert('Name and color required');
                return;
            }
            const k = n.toLowerCase().replace(/\s+/g, '_');
            const nc = {
                name: n,
                color: selectedColor,
                icon: selectedCategoryIcon || ''
            };
            if (currentCategoryType === 'event') eventCategories[k] = nc;
            else taskCategories[k] = nc;
            document.getElementById('newCategoryName').value = '';
            selectedColor = '';
            selectedCategoryIcon = '';
            renderIcons('categoryIconSelector', () => selectedCategoryIcon, ic => selectedCategoryIcon = ic);
            renderColors('colorGrid', '', c => selectedColor = c);
            save();
            renderCategoriesList();
            updateSelects();
            updateFilterDropdown(); // Refresh filter
        }

        function deleteCategory(k) {
            if (!confirm('Delete category?')) return;
            if (currentCategoryType === 'event') delete eventCategories[k];
            else delete taskCategories[k];
            save();
            renderCategoriesList();
            updateSelects();
            updateFilterDropdown(); // Refresh filter
        }

        function closeEditCategoryModal() {
            document.getElementById('editCategoryModal').style.display = 'none';
        }

        function saveEditedCategory() {
            closeEditCategoryModal();
        }
    </script>
</body>

</html>