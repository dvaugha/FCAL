<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy"
        content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval';">
    <title>COD Golf v241 WIP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" href="COD_APP_ICON.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --c1: #10B981;
            --c1d: #059669;
            --bg: #0F172A;
            --card: #1E293B;
            --mut: #94A3B8;
            --acc: #F59E0B;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #F8FAFC;
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .g-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg);
            z-index: 10;
            display: none;
            flex-direction: column;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
        }

        .g-view.active {
            display: flex;
            z-index: 100;
        }

        .box {
            background: var(--card);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .flex-r {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .g-btn {
            background: var(--c1);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 900;
            font-size: 16px;
            padding: 16px;
            text-transform: uppercase;
            width: 100%;
            cursor: pointer;
        }

        .g-btn-sm {
            padding: 8px 16px;
            font-size: 11px;
            width: auto;
            border-radius: 8px;
        }

        .g-btn-sec {
            background: #334155;
            border: 1px solid #475569;
        }

        .g-inp {
            background: #0F172A;
            border: 1px solid #334155;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            display: block;
        }

        .tx-xl {
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -0.5px;
        }

        .tx-sm {
            font-size: 12px;
            font-weight: 700;
            color: var(--mut);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .chip {
            display: inline-flex;
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 12px;
            margin: 4px;
            overflow: hidden;
            transition: 0.2s;
            -webkit-transform: translate3d(0, 0, 0);
        }

        .chip-lbl {
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 700;
            color: white;
            pointer-events: none;
        }

        .del-mode .chip {
            background: #EF4444;
            border-color: #fff;
            cursor: pointer;
        }

        .del-mode .chip-lbl {
            color: white;
            text-decoration: line-through;
            font-weight: 900;
        }

        .role-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background: #0F172A;
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid #334155;
        }

        .role-lbl {
            width: 80px;
            font-size: 10px;
            font-weight: 900;
            line-height: 1.2;
            text-transform: uppercase;
        }

        .role-sel {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: 700;
            outline: none;
        }

        .top-bar {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--card);
            margin: -20px -20px 20px -20px;
            padding: 16px;
            padding-top: max(20px, env(safe-area-inset-top));
            border-bottom: 4px solid var(--c1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .nav-btn {
            width: 52px;
            height: 52px;
            background: #334155;
            border-radius: 12px;
            color: white;
            font-size: 24px;
            font-weight: 900;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .h-stat {
            text-align: center;
            min-width: 50px;
        }

        .h-stat-lbl {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 900;
            color: var(--mut);
        }

        .h-stat-val {
            font-size: 15px;
            font-weight: 900;
            color: white;
        }

        .match-stat {
            font-size: 14px;
            font-weight: 900;
            color: white;
            text-align: right;
            text-transform: uppercase;
        }

        .match-stat em {
            color: #10B981;
            font-style: normal;
        }

        .p-card {
            background: #0F172A;
            border-radius: 24px;
            border: 1px solid #334155;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            position: relative;
        }

        .p-card.has-score {
            border-color: var(--c1);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.15);
        }

        .btn-act {
            width: 64px;
            height: 64px;
            border-radius: 18px;
            font-size: 28px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .btn-minus {
            background: #1E293B;
            border: 1px solid #334155;
            color: #F87171;
        }

        .btn-minus:active {
            background: #334155;
        }

        .btn-plus {
            background: var(--c1);
            border-bottom: 4px solid var(--c1d);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.4);
        }

        .btn-plus:active {
            border-bottom: 0;
            transform: translateY(4px);
            box-shadow: none;
        }

        .ctr-area {
            flex: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 64px;
        }

        .p-name {
            font-size: 12px;
            font-weight: 900;
            letter-spacing: 1px;
            color: var(--mut);
            text-transform: uppercase;
        }

        .p-ghost {
            font-size: 10px;
            color: #475569;
            font-weight: 700;
            margin-top: 2px;
        }

        .p-score {
            font-size: 42px;
            font-weight: 900;
            color: white;
            line-height: 1;
            display: none;
        }

        .p-card.has-score .p-score {
            display: block;
        }

        .p-card.has-score .p-ghost {
            display: none;
        }

        /* CARD SPECIFIC CSS */
        .card-con {
            margin: -20px;
            padding: 20px;
            padding-bottom: 40px;
        }

        .card-table-wrap {
            overflow-x: auto;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            -webkit-overflow-scrolling: touch;
            display: block;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin-bottom: 0;
            table-layout: fixed;
            min-width: 320px;
        }

        th,
        td {
            border: 1px solid #334155;
            padding: 4px 2px;
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            white-space: nowrap;
            height: 34px;
            box-sizing: border-box;
        }

        th {
            background: #0F172A;
            color: var(--mut);
            border-top: none;
            height: 24px;
            font-size: 9px;
            vertical-align: middle;
        }

        td {
            background: #1E293B;
            color: white;
            vertical-align: middle;
        }

        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            border-right: 2px solid #334155;
            width: 45px;
            min-width: 45px;
            max-width: 45px;
            text-align: center;
            padding: 0;
            background: #0F172A;
        }

        td:first-child {
            background: #1E293B;
            color: var(--c1);
            font-weight: 900;
        }

        .sc-val {
            display: flex;
            width: 22px;
            height: 22px;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin: 0 auto;
            font-size: 10px;
        }

        .sc-bird {
            border-radius: 50%;
            border: 1px solid #10B981;
            color: #10B981;
        }

        .sc-eagle {
            border-radius: 50%;
            border: 3px double #10B981;
            color: #10B981;
        }

        .sc-bog {
            border: 1px solid #F87171;
            color: #F87171;
        }

        .sc-dbl {
            border: 3px double #F87171;
            color: #F87171;
        }

        #auto-adv-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 16px;
            text-align: center;
            font-weight: 800;
            font-size: 16px;
            z-index: 200;
            transform: translateY(150px);
            transition: transform 0.3s;
            border-radius: 16px;
            pointer-events: none;
        }

        #auto-adv-banner.show {
            transform: translateY(0);
        }

        .hist-item {
            padding: 8px;
            border-bottom: 1px solid #334155;
            color: #cbd5e1;
            display: flex;
            align-items: center;
        }

        .hist-chk {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            accent-color: #EF4444;
            display: none;
        }

        .hist-edit-mode .hist-chk {
            display: block;
        }

        /* RECAP CSS */
        .rec-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .rec-p-lbl {
            width: 40px;
            font-size: 11px;
            font-weight: 900;
            color: #94A3B8;
        }

        .rec-bars {
            flex: 1;
            margin-left: 8px;
            display: flex;
            gap: 2px;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background: #334155;
        }

        .avg-card {
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px;
            flex: 1;
            text-align: center;
        }

        .avg-lbl {
            font-size: 10px;
            color: #94A3B8;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .avg-val {
            font-size: 16px;
            font-weight: 900;
            color: white;
        }

        .badge-box {
            background: #1E293B;
            border: 1px solid #334155;
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .badge-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .badge-tl {
            font-size: 10px;
            color: #10B981;
            font-weight: 900;
            text-transform: uppercase;
        }

        .badge-nm {
            font-size: 14px;
            font-weight: 900;
            color: white;
        }

        .badge-sub {
            font-size: 10px;
            color: #94A3B8;
        }

        /* CAPTURE NODE (FLEXBOX V2) */
        #share-node {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 580px;
            /* Slightly wider for comfort */
            background: #0F172A;
            color: white;
            padding: 24px;
            font-family: 'Outfit', sans-serif;
            border: 2px solid #334155;
            box-sizing: border-box;
        }

        .sn-head {
            font-size: 24px;
            font-weight: 900;
            color: #10B981;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .sn-sub {
            font-size: 13px;
            font-weight: 700;
            color: #cbd5e1;
            margin-bottom: 16px;
        }

        .sn-sect {
            background: #1E293B;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #334155;
        }

        .sn-sect-tl {
            color: #F59E0B;
            font-weight: 800;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .sn-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #334155;
            font-size: 14px;
            font-weight: 700;
        }

        .sn-row:last-child {
            border-bottom: none;
        }

        .sn-hl {
            color: #10B981;
        }

        .sn-neg {
            color: #F87171;
        }

        /* FLEX SCORECARD GRID */
        .sn-grid {
            display: flex;
            flex-direction: column;
            width: 100%;
            border: 1px solid #334155;
            border-bottom: none;
            /* Rows have borders */
        }

        .sn-g-row {
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid #334155;
            width: 100%;
        }

        .sn-g-row.head {
            background: #0F172A;
            height: 22px;
        }

        .sn-g-row.body {
            background: #1E293B;
            height: 26px;
        }

        .sn-col {
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #334155;
            font-size: 10px;
            font-weight: 700;
            color: white;
            box-sizing: border-box;
        }

        .sn-col:last-child {
            border-right: none;
        }

        .sn-col.nm {
            width: 50px;
            justify-content: flex-start;
            padding-left: 6px;
            text-align: left;
            font-weight: 900;
        }

        .sn-col.h {
            flex: 1;
            color: #94A3B8;
        }

        .sn-col.sc {
            flex: 1;
            font-weight: 900;
        }

        .sn-col.tot {
            width: 40px;
            color: #F59E0B;
            font-weight: 900;
        }

        .sn-col.rnd {
            width: 40px;
            color: #10B981;
            font-weight: 900;
        }

        .sn-ball {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 9px;
            /* Borders applied inline */
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-box {
            background: #1E293B;
            padding: 24px;
            border-radius: 20px;
            width: 85%;
            max-width: 340px;
            text-align: center;
            border: 1px solid #475569;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="auto-adv-banner">Hole Complete! Next in 3s...</div>

    <!-- Hidden Capture Node -->
    <div id="share-node"></div>

    <div id="press-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="tx-xl" style="margin-bottom:12px; color:white;">PRESS OPTION</div>
            <div id="pm-msg" style="margin-bottom:24px; color:#cbd5e1; font-size:16px; line-height:1.5;"></div>
            <div class="flex-r" style="gap:12px;">
                <button class="g-btn g-btn-sec" onclick="App.closePress()">NO PRESS</button>
                <button id="pm-btn" class="g-btn" style="background:#F59E0B; color:black;">YES, PRESS</button>
            </div>
        </div>
    </div>


    <!-- HCP MODAL -->
    <div id="hcp-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="tx-xl" style="margin-bottom:12px; color:white;">ROUND HANDICAPS</div>
            <div id="hcp-roster" style="margin-bottom:20px;"></div>
            <div class="flex-r" style="gap:12px;">
                <button class="g-btn g-btn-sec" onclick="App.closeHcpModal()">CANCEL</button>
                <button class="g-btn" style="background:#10B981;" onclick="App.saveHcps()">SAVE</button>
            </div>
        </div>
    </div>

    <!-- SHARE PREVIEW MODAL -->
    <div id="share-preview-modal" class="modal-overlay" style="z-index: 600;">
        <div class="modal-box" style="max-width:400px; width:90%; padding:16px;">
            <div class="tx-xl" style="margin-bottom:12px; color:white;">READY TO SHARE</div>
            <img id="sp-img" style="width:100%; border-radius:8px; border:1px solid #334155; margin-bottom:16px;" />
            <div class="flex-r" style="gap:12px;">
                <button class="g-btn g-btn-sec" onclick="App.closeSharePreview()">CLOSE</button>
                <button class="g-btn" style="background:#10B981;" onclick="App.doShareParams()">SHARE NOW</button>
            </div>
        </div>
    </div>

    <!-- === SETUP SCREEN === -->
    <!-- === SETUP SCREEN === -->
    <div id="v-setup" class="g-view active">
        <div class="flex-r" style="justify-content:center; margin-bottom:10px;">
            <div class="tx-xl">COD GOLF v241</div>
        </div>

        <div class="box" style="text-align:center; padding:16px;">
            <div class="tx-sm" style="color:#10B981; margin-bottom:6px;">GAME MODE</div>
            <select id="g-mode" class="g-inp" style="text-align:center; font-weight:900; margin-bottom:12px;">
                <option value="cod">COD (Match Play)</option>
                <option value="scramble">6-Hole Scramble (Points)</option>
            </select>

            <div class="flex-r" style="justify-content:center; gap:10px; align-items:center; margin-bottom:16px;">
                <div class="tx-sm">POT / BUY-IN $</div>
                <input type="number" id="s-pot" class="g-inp" value="20" style="width:80px; text-align:center;">
            </div>

            <button class="g-btn g-btn-lg" style="background:#EF4444; width:100%; padding:14px; font-size:16px;"
                onclick="App.tryNewGame(this)">START NEW GAME</button>
        </div>

        <!-- Roster/Seats/Settings... Same as before -->
        <div class="box">
            <div class="tx-sm">ROSTER</div>
            <div class="flex-r" style="gap:8px; margin-bottom:12px;">
                <input type="text" id="new-p-name" class="g-inp" placeholder="Name..." style="margin:0;">
                <button class="g-btn g-btn-sm" style="height:48px;" onclick="App.addRoster()">ADD</button>
            </div>
            <div id="roster-list" style="display:flex; flex-wrap:wrap;"></div>
            <button id="del-mode-btn" class="g-btn g-btn-sm" style="background:#334155; width:100%; margin-top:10px;"
                onclick="App.toggleDelMode()">ENABLE DELETE MODE</button>
            <div id="del-status"
                style="display:none; text-align:center; margin-top:5px; color:#EF4444; font-weight:bold; font-size:12px;">
                TAP NAME TO DELETE (NO UNDO)</div>
        </div>

        <div class="box">
            <div class="tx-sm">SEATS</div>
            <div class="role-row">
                <div class="role-lbl" style="color:#10B981">CART A<br>DRIVER</div><select id="sel-0" class="role-sel"
                    onchange="App.onRole()"></select>
            </div>
            <div class="role-row">
                <div class="role-lbl" style="color:#10B981">CART A<br>PASS</div><select id="sel-1" class="role-sel"
                    onchange="App.onRole()"></select>
            </div>
            <div class="role-row">
                <div class="role-lbl" style="color:#F59E0B">CART B<br>DRIVER</div><select id="sel-2" class="role-sel"
                    onchange="App.onRole()"></select>
            </div>
            <div class="role-row">
                <div class="role-lbl" style="color:#F59E0B">CART B<br>PASS</div><select id="sel-3" class="role-sel"
                    onchange="App.onRole()"></select>
            </div>
            <button class="g-btn g-btn-sm"
                style="background:#334155; width:100%; margin-top:10px; border:1px solid #475569;"
                onclick="App.openHcpModal()">SET HANDICAPS ‚õ≥</button>
        </div>

        <div class="box">
            <div class="tx-sm">SETTINGS</div>
            <div class="flex-r" style="gap:10px;">
                <div style="flex:1;">
                    <div class="tx-sm">COURSE</div>
                    <select id="s-course" class="g-inp">
                        <option value="cc">Crow Creek</option>
                        <option value="jones">Sea Trail - Jones</option>
                        <option value="maples">Sea Trail - Maples</option>
                        <option value="byrd">Sea Trail - Byrd</option>
                        <option value="so">Southern Oaks</option>
                        <option value="wl">Woodlands</option>
                        <option value="sc">Shallow Creek</option>
                        <option value="gen">Generic 72</option>
                    </select>
                </div>
                <div style="width:80px;">
                    <div class="tx-sm">SEG BET $</div>
                    <input type="number" id="s-bet" class="g-inp" value="5">
                </div>
            </div>
            <div class="flex-r" style="gap:10px; margin-top:10px;">
                <div style="flex:1;">
                    <div class="tx-sm">TEE</div>
                    <select id="s-tee" class="g-inp">
                        <option value="white">White</option>
                        <option value="gold">Gold</option>
                        <option value="combo">Combo</option>
                    </select>
                </div>
                <div style="width:80px;">
                    <div class="tx-sm">START</div>
                    <select id="s-start" class="g-inp">
                        <option value="1">#1</option>
                        <option value="10">#10</option>
                    </select>
                </div>
            </div>
            <div class="flex-r" style="gap:10px; margin-top:10px;">
                <div style="flex:1;">
                    <div class="tx-sm">GAME MODE</div>
                    <select id="g-mode" class="g-inp">
                        <option value="cod">C.O.D. (6-6-6)</option>
                        <option value="scramble">2-Man Scramble</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <div class="tx-sm">HCP MODE</div>
                    <select id="s-hcp-mode" class="g-inp">
                        <option value="standard">Standard</option>
                        <option value="spread">COD Balanced (Spread)</option>
                    </select>
                </div>
                <div style="width:60px;">
                    <div class="tx-sm">POT</div>
                    <input type="number" id="s-pot" class="g-inp" value="20">
                </div>
            </div>
        </div>

        <button class="g-btn" style="margin-bottom:20px;" onclick="App.startRound()">CONTINUE ROUND</button>

        <div class="box">
            <div class="tx-sm" style="color:#F59E0B">CAREER EARNINGS</div>
            <div id="career-earnings" style="font-size:12px; margin-top:8px;"></div>
        </div>

        <div class="box">
            <div class="flex-r">
                <div class="tx-sm">HISTORY</div>
                <button id="hist-edit-btn" class="g-btn g-btn-sm" style="background:#334155; width:auto;"
                    onclick="App.handleManageClick()">MANAGE</button>
            </div>
            <div id="hist-list" style="max-height:200px; overflow-y:auto; font-size:12px;"></div>
        </div>
    </div>

    <!-- === DASHBOARD === -->
    <div id="v-dash" class="g-view">
        <div class="top-bar">
            <div class="flex-r" style="margin-bottom:8px;">
                <button class="nav-btn" onclick="App.navH(-1)">‚Üê</button>
                <div style="flex:1; text-align:center;">
                    <div id="d-h-num" class="tx-sm" style="letter-spacing:2px; color:#94A3B8; margin:0;">HOLE 1</div>
                    <div id="d-par" style="font-size:44px; font-weight:900; line-height:1; color:white;">4</div>
                    <div id="d-tee-ind"
                        style="font-size:10px; font-weight:900; color:#F59E0B; margin-top:-2px; text-transform:uppercase;">
                        WHITE TEE</div>
                </div>
                <button class="nav-btn" style="background:#10B981;" onclick="App.navH(1)">‚Üí</button>
            </div>
            <div class="flex-r">
                <div class="h-stat">
                    <div class="h-stat-lbl">YARDS</div>
                    <div id="d-dist" class="h-stat-val">-</div>
                </div>
                <div class="h-stat">
                    <div class="h-stat-lbl">HCP</div>
                    <div id="d-hcp" class="h-stat-val">-</div>
                </div>
                <div style="flex:1; padding-right:10px;">
                    <div id="d-fmt" class="h-stat-lbl" style="text-align:right; color:#F59E0B;">CARTS</div>
                    <div id="d-status" class="match-stat">ALL SQUARE</div>
                </div>
            </div>
            <button class="g-btn g-btn-sm"
                style="background:#334155; margin-top:8px; width:100%; border:1px solid #475569;"
                onclick="App.testFill()">TEST: FILL 5 HOLES</button>
        </div>
        <div id="lbl-t1"
            style="font-size:13px; font-weight:800; color:#10B981; margin:0 0 8px 4px; text-transform:uppercase;">TEAM A
        </div>
        <div id="slot-0" class="p-card">
            <div class="btn-act btn-minus" onclick="App.mod(0,-1)">-</div>
            <div class="ctr-area" onclick="App.setPar(0)">
                <div id="nm-0" class="p-name">P1</div>
                <div id="gh-0" class="p-ghost" style="opacity:0.5;">PAR 4</div>
                <div id="sc-0" class="p-score">4</div>
            </div>
            <div class="btn-act btn-plus" onclick="App.mod(0,1)">+</div>
        </div>
        <div id="slot-1" class="p-card">
            <div class="btn-act btn-minus" onclick="App.mod(1,-1)">-</div>
            <div class="ctr-area" onclick="App.setPar(1)">
                <div id="nm-1" class="p-name">P2</div>
                <div id="gh-1" class="p-ghost" style="opacity:0.5;">PAR 4</div>
                <div id="sc-1" class="p-score">4</div>
            </div>
            <div class="btn-act btn-plus" onclick="App.mod(1,1)">+</div>
        </div>
        <div id="lbl-t2"
            style="font-size:13px; font-weight:800; color:#F59E0B; margin:16px 0 8px 4px; text-transform:uppercase;">
            TEAM B</div>
        <div id="slot-2" class="p-card">
            <div class="btn-act btn-minus" onclick="App.mod(2,-1)">-</div>
            <div class="ctr-area" onclick="App.setPar(2)">
                <div id="nm-2" class="p-name">P3</div>
                <div id="gh-2" class="p-ghost" style="opacity:0.5;">PAR 4</div>
                <div id="sc-2" class="p-score">4</div>
            </div>
            <div class="btn-act btn-plus" onclick="App.mod(2,1)">+</div>
        </div>
        <div id="slot-3" class="p-card">
            <div class="btn-act btn-minus" onclick="App.mod(3,-1)">-</div>
            <div class="ctr-area" onclick="App.setPar(3)">
                <div id="nm-3" class="p-name">P4</div>
                <div id="gh-3" class="p-ghost" style="opacity:0.5;">PAR 4</div>
                <div id="sc-3" class="p-score">4</div>
            </div>
            <div class="btn-act btn-plus" onclick="App.mod(3,1)">+</div>
        </div>
        <div style="height:30px;"></div>
        <div class="flex-r" style="gap:10px;"><button class="g-btn" style="background:#334155;"
                onclick="App.nav('v-setup')">MENU</button><button class="g-btn" style="background:#334155; flex:1;"
                onclick="App.nav('v-card')">SCORECARD</button><button class="g-btn" style="background:#EF4444;"
                onclick="App.nav('v-card')">END</button></div>
    </div>

    <!-- === CARD/SUMMARY SCREENS === -->
    <div id="v-card" class="g-view">
        <div class="flex-r" style="margin-bottom:10px;">
            <div class="tx-xl">CARD</div><button class="g-btn g-btn-sm" style="width:auto;"
                onclick="App.nav('v-dash')">BACK TO GAME</button>
        </div>

        <!-- Scorecard Container -->
        <div id="card-con-body" class="card-con"></div>

        <!-- === SPACER AND RESULTS === -->
        <!-- Forced Spacer matching the gap above Gross Totals -->
        <div style="height:20px; width:100%;"></div>

        <div class="box" style="margin-top:0;">
            <div class="tx-sm" style="color:#10B981">SEGMENT RESULTS</div>
            <div id="res-txt" style="font-family:monospace; margin-top:10px; font-size:14px; line-height:1.5;"></div>
        </div>

        <div class="box" style="background:rgba(245, 158, 11, 0.1); border:1px solid rgba(245, 158, 11, 0.3);">
            <div style="font-size:11px; color:#F59E0B; font-weight:700;">‚ÑπÔ∏è IPHONE TIP</div>
            <div style="font-size:10px; color:#cbd5e1; margin-top:4px;">If tapping SEND doesn't open messages, the
                scorecard is already copied. Just open Messages and Paste.</div>
        </div>

        <button class="g-btn" style="background:#334155; border:1px solid #F59E0B; color:#F59E0B; margin-bottom:12px;"
            onclick="App.nav('v-recap')">üìä ROUND RECAP</button>

        <button id="sms-btn" class="g-btn" style="margin-bottom:20px;" onclick="App.share()">SHARE IMAGE
            SUMMARY</button>
        <button id="hist-btn" class="g-btn g-btn-sec" style="margin-bottom:12px;" onclick="App.saveToHistory()">SAVE TO
            HISTORY</button>
        <button class="g-btn" style="background:#EF4444;" onclick="App.tryNewGame(this)">START NEW ROUND</button>
    </div>

    <!-- === ROUND RECAP === -->
    <div id="v-recap" class="g-view">
        <div class="flex-r" style="margin-bottom:16px;">
            <div class="tx-xl">ROUND RECAP</div>
            <button class="g-btn g-btn-sm" style="width:auto; background:#334155;"
                onclick="App.nav('v-card')">CLOSE</button>
        </div>
        <div id="recap-body"></div>
    </div>

    <script>
        const CS = {
            'cc': {
                n: 'Crow Creek',
                p: [4, 4, 5, 4, 4, 3, 5, 3, 4, 4, 4, 5, 3, 4, 4, 3, 4, 5],
                y: {
                    white: [339, 382, 480, 331, 362, 165, 534, 168, 359, 358, 319, 517, 142, 417, 367, 156, 361, 519],
                    gold: [302, 308, 440, 291, 323, 132, 487, 141, 319, 302, 306, 470, 129, 351, 323, 130, 316, 458],
                    combo: [339, 308, 480, 331, 362, 132, 487, 141, 359, 358, 319, 470, 129, 351, 367, 130, 361, 458]
                },
                hcp: [17, 1, 5, 7, 9, 13, 3, 15, 11, 12, 16, 2, 18, 4, 10, 14, 6, 8],
                cmb: [0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1]
            },
            'jones': {
                n: 'Sea Trail - Jones',
                p: [4, 3, 4, 4, 3, 4, 4, 5, 5, 4, 4, 4, 3, 4, 5, 4, 3, 5],
                y: {
                    white: [405, 178, 350, 365, 155, 375, 385, 482, 510, 328, 395, 385, 127, 320, 535, 405, 144, 490],
                    gold: [385, 160, 327, 300, 115, 330, 327, 458, 488, 305, 355, 347, 110, 298, 455, 367, 134, 455],
                    combo: []
                },
                hcp: [5, 17, 15, 11, 13, 3, 1, 7, 9, 10, 8, 6, 18, 14, 4, 2, 16, 12],
                cmb: [0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1]
            },
            'maples': {
                n: 'Sea Trail - Maples',
                p: [4, 4, 3, 5, 3, 5, 4, 4, 4, 4, 3, 5, 4, 4, 5, 4, 3, 4],
                y: {
                    white: [295, 335, 150, 525, 170, 535, 375, 380, 445, 385, 140, 475, 315, 325, 540, 330, 160, 315],
                    gold: [275, 315, 120, 510, 160, 520, 365, 365, 420, 345, 105, 420, 225, 245, 485, 275, 110, 270],
                    combo: []
                },
                hcp: [15, 5, 17, 9, 13, 1, 3, 11, 7, 2, 18, 12, 14, 6, 4, 16, 10, 8],
                cmb: [0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0]
            },
            'byrd': {
                n: 'Sea Trail - Byrd',
                p: [4, 3, 5, 4, 4, 4, 3, 4, 5, 4, 4, 3, 5, 4, 4, 3, 4, 5],
                y: {
                    white: [344, 165, 445, 384, 395, 360, 138, 367, 513, 383, 343, 154, 494, 356, 366, 160, 359, 417],
                    gold: [304, 139, 424, 326, 374, 313, 121, 327, 460, 359, 273, 116, 456, 343, 337, 125, 311, 344],
                    combo: []
                },
                hcp: [13, 15, 3, 1, 7, 11, 17, 9, 5, 4, 8, 16, 2, 6, 12, 18, 10, 14],
                cmb: [0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1]
            },
            'so': {
                n: 'Southern Oaks',
                p: [5, 3, 5, 3, 4, 3, 4, 4, 5, 5, 3, 4, 5, 3, 5, 4, 3, 4],
                y: {
                    white: [489, 139, 453, 130, 346, 110, 322, 349, 438, 457, 154, 341, 448, 137, 432, 295, 131, 373],
                    gold: [458, 125, 369, 115, 301, 78, 253, 290, 381, 406, 118, 254, 418, 100, 410, 266, 94, 310],
                    combo: []
                },
                hcp: [5, 11, 13, 9, 1, 15, 7, 3, 17, 14, 8, 2, 10, 6, 18, 16, 12, 4],
                cmb: [1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1]
            },
            'wl': {
                n: 'Woodlands',
                p: [4, 4, 5, 3, 4, 5, 3, 4, 4, 4, 5, 4, 4, 3, 4, 5, 3, 4],
                y: {
                    white: [344, 364, 475, 116, 295, 460, 157, 323, 314, 337, 447, 348, 325, 132, 318, 452, 125, 353],
                    gold: [306, 308, 461, 78, 278, 448, 130, 265, 256, 327, 374, 323, 286, 102, 285, 415, 102, 310],
                    combo: []
                },
                hcp: [3, 1, 7, 17, 15, 5, 9, 11, 13, 6, 12, 8, 2, 14, 10, 16, 18, 4],
                cmb: [1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1]
            },
            'sc': {
                n: 'Shallow Creek',
                p: [5, 3, 4, 4, 3, 4, 5, 3, 4, 4, 3, 4, 5, 3, 4, 3, 4, 5],
                y: {
                    white: [455, 128, 350, 262, 119, 310, 473, 130, 352, 327, 123, 324, 462, 146, 339, 137, 322, 450],
                    gold: [501, 160, 391, 385, 220, 423, 557, 157, 429, 381, 180, 388, 523, 210, 403, 163, 466, 531],
                    combo: []
                },
                hcp: [13, 9, 5, 17, 15, 1, 7, 11, 3, 4, 16, 8, 14, 12, 2, 10, 6, 18],
                cmb: []
            },
            'gen': { n: 'Generic 72', p: [4, 4, 3, 4, 4, 5, 4, 3, 5, 4, 4, 3, 4, 4, 5, 4, 3, 5], y: { white: [], gold: [], combo: [] }, hcp: [], cmb: [] }
        };

        ['jones', 'maples', 'byrd', 'so', 'wl'].forEach(k => {
            const c = CS[k];
            if (c.y.combo.length === 0 && c.y.white.length > 0) {
                for (let i = 0; i < 18; i++) {
                    const useGold = c.cmb[i] === 1;
                    c.y.combo[i] = useGold ? c.y.gold[i] : c.y.white[i];
                }
            }
        });

        const App = {
            d: { roster: ['Dan', 'Mike', 'Steve', 'John'], ps: ['', '', '', ''], chosen: { 0: '', 1: '', 2: '', 3: '' }, bet: 5, pot: 20, gameType: 'cod', crs: 'jones', tee: 'white', start: 1, h: 1, s: {}, history: [], gameId: null },
            slotMap: {}, tmr: null, corr: false, delMode: false, histEdit: false,
            selIds: [],
            wakeLock: null,
            keepAwake: async function () {
                if ('wakeLock' in navigator) {
                    try {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        console.log("WakeLock Active");
                    } catch (e) { console.log("WakeLock Err", e); }
                }
            },

            init: function () {
                try {
                    let s = localStorage.getItem('GOLF_241');
                    if (!s) {
                        const old = localStorage.getItem('GOLF_240');
                        if (old) { this.d = JSON.parse(old); this.save(); }
                    }
                    if (s) this.d = JSON.parse(s);
                    if (!this.d.history) this.d.history = [];
                    if (!this.d.start) this.d.start = 1;
                    if (!this.d.press) this.d.press = [null, null, null];
                    if (!this.d.hcps) this.d.hcps = {};
                    if (!this.d.gameType) this.d.gameType = 'cod';
                    if (!this.d.pot) this.d.pot = 20;
                    if (!this.d.hcpMode) this.d.hcpMode = 'standard';
                    if (!this.d.permHcps) this.d.permHcps = {};
                } catch (e) { }
                this.renderRoster(); this.renderHistory(); this.refreshDrop(); this.restoreSet();
                if (Object.keys(this.d.s).length > 0 && this.d.ps[0]) this.nav('v-dash'); else this.nav('v-setup');
                if ('wakeLock' in navigator) {
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') this.keepAwake();
                    });
                    this.keepAwake();
                }
            },
            save: (function () {
                let t = null;
                return function () {
                    clearTimeout(t);
                    t = setTimeout(() => {
                        localStorage.setItem('GOLF_241', JSON.stringify(this.d));
                    }, 500);
                };
            })(),

            tryNewGame: function (btn) {
                if (btn.innerText.includes("CONFIRM")) {
                    this.resetScores();
                } else {
                    const oldText = btn.innerText;
                    btn.innerText = "CONFIRM NEW ROUND?";
                    btn.style.backgroundColor = "#B91C1C";
                    setTimeout(() => {
                        btn.innerText = oldText;
                        btn.style.backgroundColor = "#EF4444";
                    }, 3000);
                }
            },

            resetScores: function () {
                this.d.s = {};
                this.d.hcps = {};
                this.d.start = parseInt(document.getElementById('s-start').value);
                this.d.h = this.d.start;
                this.d.ps = ['', '', '', ''];
                this.d.chosen = { 0: '', 1: '', 2: '', 3: '' };
                delete this.d.gameId;
                this.save();
                this.renderRoster();
                this.refreshDrop();
                this.restoreSet();
                this.nav('v-setup');
            },

            nav: function (id) {
                document.querySelectorAll('.g-view').forEach(e => e.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if (id === 'v-dash') this.uDash();
                if (id === 'v-card') this.uCard();
                if (id === 'v-recap') this.uRecap();
            },

            navH: function (d) {
                if (this.tmr) clearTimeout(this.tmr);
                document.getElementById('auto-adv-banner').classList.remove('show');

                let n;
                if (d === 1) {
                    if (this.d.start === 10) {
                        if (this.d.h === 18) n = 1;
                        else if (this.d.h === 9) n = 19; // Done
                        else n = this.d.h + 1;
                    } else {
                        n = this.d.h + 1;
                    }
                }
                else {
                    this.corr = true;
                    if (this.d.start === 10) {
                        if (this.d.h === 1) n = 18;
                        else if (this.d.h === 10) n = 10;
                        else n = this.d.h - 1;
                    } else {
                        if (this.d.h === 1) n = 1;
                        else n = this.d.h - 1;
                    }
                }

                if (n > 18) { alert("Done"); this.nav('v-card'); return; }
                this.d.h = n;
                this.save();
                this.uDash();
                this.checkPressModal();
            },

            mod: function (idx, delta) {
                if (!this.d.s[this.d.h]) this.d.s[this.d.h] = {};
                const pid = this.slotMap[idx];
                let s = this.d.s[this.d.h][pid] || (CS[this.d.crs].p[this.d.h - 1]);
                s += delta;
                if (s < 1) s = 1;
                this.d.s[this.d.h][pid] = s;
                this.save();
                this.uDash();
                this.checkAuto();
            },
            setPar: function (idx) {
                if (!this.d.s[this.d.h]) this.d.s[this.d.h] = {};
                const pid = this.slotMap[idx];
                this.d.s[this.d.h][pid] = CS[this.d.crs].p[this.d.h - 1];
                this.save();
                this.uDash();
                this.checkAuto();
            },
            checkAuto: function () {
                const s = this.d.s[this.d.h];
                if (s && Object.keys(s).length === 4 && Object.values(s).every(v => v > 0)) {
                    document.getElementById('auto-adv-banner').classList.add('show');
                    if (this.tmr) clearTimeout(this.tmr);
                    this.tmr = setTimeout(() => { this.navH(1); }, 3000);
                }
            },

            testFill: function () {
                try {
                    const c = CS[this.d.crs] || CS['cc'];
                    if (!this.d.ps[0]) { alert("Start round first!"); return; }

                    if (Object.keys(this.slotMap).length === 0) {
                        [0, 1, 2, 3].forEach(i => this.slotMap[i] = i);
                    }

                    for (let i = 0; i < 5; i++) {
                        const hIdx = this.d.h - 1;
                        const par = c.p[hIdx];
                        const hAlloc = c.hcp[hIdx];
                        if (!this.d.s[this.d.h]) this.d.s[this.d.h] = {};

                        [0, 1, 2, 3].forEach(p => {
                            const pid = (this.slotMap[p] !== undefined) ? this.slotMap[p] : p;
                            // Realistic Score Gen
                            const hcp = (this.d.hcps && this.d.hcps[pid] !== undefined) ? this.d.hcps[pid] : 18; // Default 18
                            let strokes = 0;
                            if (hcp >= hAlloc) strokes = 1;
                            if (hcp - 18 >= hAlloc) strokes = 2;

                            const exp = par + strokes;
                            // Variance: -1 (Birdie/Par save) to +1 (Bogey/Double)
                            const v = Math.floor(Math.random() * 3) - 1;
                            this.d.s[this.d.h][pid] = Math.max(1, exp + v);
                        });

                        let nextH;
                        if (this.d.start === 10) {
                            if (this.d.h === 18) nextH = 1;
                            else if (this.d.h === 9) nextH = 99;
                            else nextH = this.d.h + 1;
                        } else {
                            if (this.d.h === 18) nextH = 99;
                            else nextH = this.d.h + 1;
                        }

                        if (nextH === 99) {
                            this.save();
                            this.nav('v-card');
                            return;
                        }
                        this.d.h = nextH;
                    }
                    this.save();
                    this.uDash();
                    this.checkPressModal();
                } catch (e) {
                    alert("Test Error: " + e.message);
                }
            },

            toggleDelMode: function () { this.delMode = !this.delMode; const b = document.getElementById('del-mode-btn'), l = document.getElementById('roster-list'), s = document.getElementById('del-status'); if (this.delMode) { b.innerText = "DONE DELETING"; b.style.background = "#EF4444"; l.classList.add('del-mode'); s.style.display = "block"; } else { b.innerText = "ENABLE DELETE MODE"; b.style.background = "#334155"; l.classList.remove('del-mode'); s.style.display = "none"; } },
            renderRoster: function () { const c = document.getElementById('roster-list'); c.innerHTML = ''; this.d.roster.forEach(p => { const d = document.createElement('div'); d.className = 'chip'; d.innerHTML = `<div class="chip-lbl">${p}</div>`; d.setAttribute('onclick', `App.clickRoster('${p.replace(/'/g, "\\'")}')`); c.appendChild(d); }); },
            clickRoster: function (p) { if (this.delMode) this.delP(p); },
            addRoster: function () { const el = document.getElementById('new-p-name'); const v = el.value.trim(); if (v && !this.d.roster.includes(v)) { this.d.roster.push(v); el.value = ''; this.save(); this.renderRoster(); this.refreshDrop(); } },
            delP: function (p) { this.d.roster = this.d.roster.filter(n => n !== p); this.save(); this.renderRoster(); this.refreshDrop(); },
            refreshDrop: function () { [0, 1, 2, 3].forEach(i => { const el = document.getElementById('sel-' + i); const c = this.d.chosen[i]; const u = [];[0, 1, 2, 3].forEach(k => { if (k !== i && this.d.chosen[k]) u.push(this.d.chosen[k]) }); const o = this.d.roster.filter(n => !u.includes(n)); if (c && !u.includes(c) && !o.includes(c) && this.d.roster.includes(c)) o.push(c); let h = '<option value="">--</option>'; o.forEach(x => { h += `<option value="${x}" ${x === c ? 'selected' : ''}>${x}</option>` }); el.innerHTML = h; el.value = c; }); },
            onRole: function () { [0, 1, 2, 3].forEach(i => this.d.chosen[i] = document.getElementById('sel-' + i).value); this.save(); this.refreshDrop(); },
            openHcpModal: function () {
                const c = document.getElementById('hcp-roster');
                c.innerHTML = '';
                [0, 1, 2, 3].forEach(i => {
                    const p = this.d.chosen[i];
                    let v = '';
                    if (p) {
                        if (this.d.hcps && this.d.hcps[p] !== undefined) v = this.d.hcps[p];
                        else if (this.d.permHcps && this.d.permHcps[p] !== undefined) v = this.d.permHcps[p];
                    }
                    const lbl = p || `Seat ${i + 1}`;
                    c.innerHTML += `<div class="flex-r" style="margin-bottom:8px;"><div style="font-weight:700; color:white; font-size:14px; flex:1; text-align:left;">${lbl}</div><input id="hcp-in-${i}" type="number" class="g-inp" style="width:80px; padding:8px;" value="${v}" placeholder="-"></div>`;
                });
                document.getElementById('hcp-modal').classList.add('active');
            },
            saveHcps: function () {
                if (!this.d.hcps) this.d.hcps = {};
                if (!this.d.permHcps) this.d.permHcps = {};
                [0, 1, 2, 3].forEach(i => {
                    const el = document.getElementById(`hcp-in-${i}`);
                    const p = this.d.chosen[i];
                    if (p && el.value !== '') {
                        const val = Number(el.value);
                        this.d.hcps[p] = val;
                        this.d.permHcps[p] = val; // Persist
                    } else if (p) {
                        delete this.d.hcps[p];
                    }
                });
                this.save();
                this.closeHcpModal();
            },
            closeHcpModal: function () { document.getElementById('hcp-modal').classList.remove('active'); },
            restoreSet: function () {
                const ids = ['s-course', 's-tee', 's-bet', 's-start', 'g-mode', 's-pot', 's-hcp-mode'];
                ids.forEach(k => {
                    const el = document.getElementById(k);
                    const prop = k.replace('s-', '').replace('g-mode', 'gameType').replace('hcp-mode', 'hcpMode');
                    if (el && this.d[prop] !== undefined) el.value = this.d[prop];
                });
            },
            startRound: function () {
                const p = [0, 1, 2, 3].map(i => this.d.chosen[i]);
                if (p.some(x => !x)) { alert("Seats!"); return; }
                this.d.ps = p;
                this.d.crs = document.getElementById('s-course').value;
                this.d.tee = document.getElementById('s-tee').value;
                this.d.bet = parseInt(document.getElementById('s-bet').value);
                this.d.start = parseInt(document.getElementById('s-start').value);
                this.d.gameType = document.getElementById('g-mode').value;
                this.d.pot = parseInt(document.getElementById('s-pot').value) || 20;
                this.d.hcpMode = document.getElementById('s-hcp-mode').value || 'standard';
                this.d.s = {};
                this.d.press = {};
                this.d.h = this.d.start;
                this.save();
                this.nav('v-dash');
                this.keepAwake();
            },

            getPops: function (pIdx, hIdx, useFull) {
                if (!this.d.hcps || Object.keys(this.d.hcps).length === 0) return 0;

                // 1. Calculate Base Handicap / Difference
                let ph = (this.d.chosen[pIdx] && this.d.hcps[this.d.chosen[pIdx]]) ? this.d.hcps[this.d.chosen[pIdx]] : 0;
                let diff = ph;

                if (!useFull) {
                    const allH = [0, 1, 2, 3].map(i => { const n = this.d.chosen[i]; return (n && this.d.hcps[n] !== undefined) ? this.d.hcps[n] : 0; });
                    const min = Math.min(...allH);
                    diff = ph - min;
                }

                if (diff <= 0) return 0;

                // 2. Allocation Logic
                const mode = this.d.hcpMode || 'standard';
                const course = CS[this.d.crs];
                const holeAlloc = course.hcp[hIdx]; // 1-18

                if (mode === 'spread') {
                    // Spread: Distribute diff evenly across 3 segments (6 holes each)
                    const basePerSeg = Math.floor(diff / 3);
                    const rem = diff % 3;

                    // Determine which segment this hole is in (relative to 1-18 logic, not start hole)
                    // HIdx is 0-17. Holes 1-6=Seg0, 7-12=Seg1, 13-18=Seg2
                    const segIdx = Math.floor(hIdx / 6);
                    let strokesForSeg = basePerSeg;

                    // Distribute remainder to segments with hardest holes?
                    // Simple logic: Seg 0 gets 1st rem, Seg 1 gets 2nd.
                    if (segIdx < rem) strokesForSeg++;

                    if (strokesForSeg === 0) return 0;

                    // Handling High Handicaps (where >1 stroke per hole might be needed)
                    const baseStrokes = Math.floor(strokesForSeg / 6);
                    const remStrokes = strokesForSeg % 6;

                    // Within this segment, find the rank of this hole relative to others in segment
                    const sStart = segIdx * 6;
                    const sEnd = sStart + 6;
                    const segHcpVals = course.hcp.slice(sStart, sEnd);

                    // Rank these 6 holes (1 = hardest in seg, 6 = easiest)
                    const sorted = [...segHcpVals].sort((a, b) => a - b);
                    const myRank = sorted.indexOf(holeAlloc); // 0..5

                    // If myRank < remStrokes, get an extra stroke on top of base
                    if (myRank < remStrokes) return baseStrokes + 1;
                    return baseStrokes;

                } else {
                    // Standard Match Play Allocation (1-18)
                    if (diff < holeAlloc) return 0;
                    return Math.floor((diff - holeAlloc) / 18) + 1;
                }
            },

            calcSeg: function (idx) {
                const segs = [{ t1: [0, 1], t2: [2, 3] }, { t1: [0, 3], t2: [1, 2] }, { t1: [0, 2], t2: [1, 3] }];
                const seg = segs[idx];
                const press = (this.d.press && this.d.press[idx]) ? this.d.press[idx] : null;

                const getHoles = (segIdx) => {
                    const hArr = [];
                    const sRH = (segIdx * 6) + 1;
                    for (let k = 0; k < 6; k++) {
                        let rh = sRH + k; let absH = rh;
                        if (this.d.start === 10) { if (rh <= 9) absH = rh + 9; else absH = rh - 9; }
                        hArr.push(absH);
                    }
                    return hArr;
                };
                const holes = getHoles(idx);
                let w1 = 0, w2 = 0; let lhWin = 0;
                const gt = this.d.gameType;

                let sum1 = 0, sum2 = 0; // For Scramble Totals
                let birds = { t1: 0, t2: 0 };

                holes.forEach((h, i) => {
                    const s = this.d.s[h];
                    if (s && Object.keys(s).length === 4) {
                        const c = CS[this.d.crs] || CS['cc'];
                        const par = c.p[h - 1];

                        if (gt === 'scramble') {
                            // Scramble: Team Score is MIN of partners
                            // Assuming GROSS for now as requested
                            const sc1 = Math.min(s[seg.t1[0]], s[seg.t1[1]]);
                            const sc2 = Math.min(s[seg.t2[0]], s[seg.t2[1]]);
                            sum1 += sc1;
                            sum2 += sc2;
                            if (sc1 < par) birds.t1++;
                            if (sc2 < par) birds.t2++;
                        } else {
                            // COD Match Play (Net)
                            let b1 = Math.min(s[seg.t1[0]] - this.getPops(seg.t1[0], h - 1), s[seg.t1[1]] - this.getPops(seg.t1[1], h - 1));
                            let b2 = Math.min(s[seg.t2[0]] - this.getPops(seg.t2[0], h - 1), s[seg.t2[1]] - this.getPops(seg.t2[1], h - 1));
                            if (b1 < b2) { w1++; if (i === 5) lhWin = 1; }
                            else if (b2 < b1) { w2++; if (i === 5) lhWin = 2; }
                        }
                    }
                });

                if (gt === 'scramble') {
                    let pts1 = birds.t1, pts2 = birds.t2;
                    let winner = 0;
                    // Block Win (3 pts) / Tie (1 pt)
                    if (sum1 < sum2) { pts1 += 3; winner = 1; }
                    else if (sum2 < sum1) { pts2 += 3; winner = 2; }
                    else { pts1 += 1; pts2 += 1; } // Tie

                    let amt = this.d.bet;
                    if (press) amt = amt * 2;

                    return { winner, amt, w1: pts1, w2: pts2, seg, press, isScramble: true };
                }

                // COD Standard
                let winner = 0; let amt = this.d.bet;
                if (press) {
                    const pt = press.team;
                    if (lhWin === pt) {
                        if (press.type === 1) { winner = pt; amt = this.d.bet; }
                        else { winner = 0; }
                    } else if (lhWin !== 0 && lhWin !== pt) {
                        winner = (pt === 1 ? 2 : 1); amt = this.d.bet * 2;
                    } else {
                        if (w1 > w2) winner = 1; else if (w2 > w1) winner = 2;
                    }
                } else {
                    if (w1 > w2) winner = 1; else if (w2 > w1) winner = 2;
                }
                return { winner, amt, w1, w2, seg, press, isScramble: false };
            },

            togglePress: function (idx, type, team) {
                if (this.d.press[idx]) this.d.press[idx] = null;
                else this.d.press[idx] = { type, team };
                this.save(); this.uDash();
            },

            checkPressModal: function () {
                let rh = this.d.h;
                if (this.d.start === 10) { if (this.d.h >= 10) rh = this.d.h - 9; else rh = this.d.h + 9; }
                if (rh % 6 !== 0) return;
                let m = (rh / 6) - 1;
                let r = this.calcSeg(m);
                let diff = r.w1 - r.w2;
                if (this.d.press && this.d.press[m]) return;
                if (diff !== 0) {
                    let trailing = diff > 0 ? 2 : 1;
                    let absD = Math.abs(diff);
                    let type = absD === 1 ? 1 : 2;

                    const tIdx = trailing === 1 ? r.seg.t1 : r.seg.t2;
                    const names = tIdx.map(i => this.d.ps[i]).join(" & ");

                    let pType = type === 1 ? "WIN SEGMENT" : "PUSH";
                    document.getElementById('pm-msg').innerHTML = `<div style="font-weight:900; color:${trailing === 1 ? '#10B981' : '#F59E0B'}; font-size:18px;">${names}</div><div style="font-size:14px; margin-top:4px;">Down by ${absD}. Press?</div>`;
                    const btn = document.getElementById('pm-btn');
                    btn.innerText = `YES (${pType})`;
                    btn.onclick = () => { this.togglePress(m, type, trailing); this.closePress(); };
                    document.getElementById('press-modal').classList.add('active');
                }
            },
            closePress: function () { document.getElementById('press-modal').classList.remove('active'); },

            uRecap: function () {
                const c = CS[this.d.crs] || CS['cc'];
                const pStats = [0, 1, 2, 3].map(i => ({
                    id: i, name: this.d.ps[i],
                    dist: { bird: 0, par: 0, bog: 0, dbl: 0 },
                    p3: { tot: 0, cnt: 0 }, p4: { tot: 0, cnt: 0 }, p5: { tot: 0, cnt: 0 },
                    netToPar: 0, birds: 0, pars: 0, dbls: 0, totalStrokes: 0
                }));

                let completedHoles = 0;
                for (let h = 1; h <= 18; h++) {
                    if (!this.d.s[h]) continue;
                    const par = c.p[h - 1];
                    let any = false;
                    [0, 1, 2, 3].forEach(i => {
                        if (typeof this.d.s[h][i] === 'number') {
                            any = true;
                            const g = this.d.s[h][i];
                            const pops = this.getPops(i, h - 1);
                            const n = g - pops;
                            const d = n - par;
                            const grel = g - par;
                            pStats[i].totalStrokes++;
                            if (grel <= -1) { pStats[i].dist.bird++; pStats[i].birds++; }
                            else if (grel === 0) { pStats[i].dist.par++; pStats[i].pars++; }
                            else if (grel === 1) pStats[i].dist.bog++;
                            else { pStats[i].dist.dbl++; pStats[i].dbls++; }
                            pStats[i].netToPar += d;
                            if (par === 3) { pStats[i].p3.tot += g; pStats[i].p3.cnt++; }
                            if (par === 4) { pStats[i].p4.tot += g; pStats[i].p4.cnt++; }
                            if (par === 5) { pStats[i].p5.tot += g; pStats[i].p5.cnt++; }
                        }
                    });
                    if (any) completedHoles++;
                }

                const con = document.getElementById('recap-body');
                if (completedHoles === 0) { con.innerHTML = '<div style="padding:20px; text-align:center; color:#94A3B8;">No scores yet.</div>'; return; }

                let html = '';
                // BADGES
                let bestNet = 999;
                pStats.forEach(p => { if (p.totalStrokes > 0 && p.netToPar < bestNet) bestNet = p.netToPar; });
                const mvps = pStats.filter(p => p.totalStrokes > 0 && p.netToPar === bestNet);
                if (mvps.length > 0) {
                    const names = mvps.map(p => p.name).join(', ');
                    const val = (bestNet > 0 ? '+' : '') + bestNet;
                    html += `<div class="badge-box" style="border-color:#10B981; background:rgba(16, 185, 129, 0.1);"><div class="badge-icon">üèÜ</div><div><div class="badge-tl">MVP (Low Net)</div><div class="badge-nm">${names}</div><div class="badge-sub">${val} to Par</div></div></div>`;
                }
                let maxBirds = -1;
                pStats.forEach(p => { if (p.birds > maxBirds) maxBirds = p.birds; });
                const bMachs = (maxBirds > 0) ? pStats.filter(p => p.birds === maxBirds) : [];
                if (bMachs.length > 0) {
                    const names = bMachs.map(p => p.name).join(', ');
                    html += `<div class="badge-box"><div class="badge-icon">ü¶Ö</div><div><div class="badge-tl">Birdie Machine</div><div class="badge-nm">${names}</div><div class="badge-sub">${maxBirds} Birdies</div></div></div>`;
                }
                let maxDbl = -1;
                pStats.forEach(p => { if (p.dbls > maxDbl) maxDbl = p.dbls; });
                const wrecks = (maxDbl > 0) ? pStats.filter(p => p.dbls === maxDbl) : [];
                if (wrecks.length > 0) {
                    const names = wrecks.map(p => p.name).join(', ');
                    html += `<div class="badge-box"><div class="badge-icon">üöÇ</div><div><div class="badge-tl" style="color:#F87171">Train Wreck</div><div class="badge-nm">${names}</div><div class="badge-sub">${maxDbl} Doubles or Worse</div></div></div>`;
                }

                // CHARTS
                html += `<div class="box" style="margin-top:20px;"><div class="tx-sm" style="color:white; margin-bottom:12px;">SCORING BREAKDOWN (GROSS)</div>`;
                pStats.forEach(p => {
                    if (p.totalStrokes === 0) return;
                    const tot = p.totalStrokes;
                    const bPct = (p.dist.bird / tot) * 100;
                    const dPct = (p.dist.dbl / tot) * 100;
                    const parPct = (p.dist.par / tot) * 100;
                    const bogPct = (p.dist.bog / tot) * 100;
                    html += `<div class="rec-row"><div class="rec-p-lbl">${p.name.substring(0, 3)}</div><div class="rec-bars"><div style="width:${bPct}%; background:#10B981;"></div><div style="width:${parPct}%; background:#cbd5e1;"></div><div style="width:${bogPct}%; background:#F59E0B;"></div><div style="width:${dPct}%; background:#EF4444;"></div></div></div>`;
                });
                html += `<div class="flex-r" style="justify-content:center; gap:12px; margin-top:8px;"><div style="display:flex; align-items:center; gap:4px;"><div style="width:8px; height:8px; border-radius:50%; background:#10B981;"></div><span class="tx-sm" style="margin:0;">Bird</span></div><div style="display:flex; align-items:center; gap:4px;"><div style="width:8px; height:8px; border-radius:50%; background:#cbd5e1;"></div><span class="tx-sm" style="margin:0;">Par</span></div><div style="display:flex; align-items:center; gap:4px;"><div style="width:8px; height:8px; border-radius:50%; background:#F59E0B;"></div><span class="tx-sm" style="margin:0;">Bog</span></div><div style="display:flex; align-items:center; gap:4px;"><div style="width:8px; height:8px; border-radius:50%; background:#EF4444;"></div><span class="tx-sm" style="margin:0;">Dbl+</span></div></div></div>`;

                // AVERAGES
                html += `<div class="box" style="margin-top:12px;"><div class="tx-sm" style="color:white; margin-bottom:8px;">SCORING AVERAGES</div><div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px;"><div class="tx-sm" style="text-align:left;">PLAYER</div><div class="tx-sm" style="text-align:center;">PAR 3</div><div class="tx-sm" style="text-align:center;">PAR 4</div><div class="tx-sm" style="text-align:center;">PAR 5</div></div>`;
                pStats.forEach(p => {
                    const a3 = p.p3.cnt ? (p.p3.tot / p.p3.cnt).toFixed(1) : '-';
                    const a4 = p.p4.cnt ? (p.p4.tot / p.p4.cnt).toFixed(1) : '-';
                    const a5 = p.p5.cnt ? (p.p5.tot / p.p5.cnt).toFixed(1) : '-';
                    html += `<div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; padding:6px 0; border-top:1px solid #334155;"><div style="font-size:12px; font-weight:700; color:#cbd5e1;">${p.name.substring(0, 8)}</div><div style="font-size:12px; font-weight:700; color:white; text-align:center;">${a3}</div><div style="font-size:12px; font-weight:700; color:white; text-align:center;">${a4}</div><div style="font-size:12px; font-weight:700; color:white; text-align:center;">${a5}</div></div>`;
                });
                html += `</div>`;
                con.innerHTML = html;
            },

            uDash: function () {
                const c = CS[this.d.crs], par = c.p[this.d.h - 1];
                document.getElementById('d-h-num').innerText = "HOLE " + this.d.h;
                document.getElementById('d-par').innerText = par;
                const dists = c.y[this.d.tee] || [];
                document.getElementById('d-dist').innerText = dists[this.d.h - 1] || '-';
                document.getElementById('d-hcp').innerText = (c.hcp[this.d.h - 1] || '-');
                let tT = this.d.tee.toUpperCase() + " TEE";
                if (this.d.tee === 'combo') { const isGold = (c.cmb && c.cmb[this.d.h - 1] === 1); if (isGold) tT = "GOLD TEE"; else tT = "WHITE TEE"; }
                document.getElementById('d-tee-ind').innerText = tT;
                document.getElementById('d-tee-ind').style.color = (tT.includes('GOLD') ? '#F59E0B' : 'white');

                // RELATIVE HOLE LOGIC
                let rh = this.d.h;
                if (this.d.start === 10) {
                    if (this.d.h >= 10) rh = this.d.h - 9;
                    else rh = this.d.h + 9;
                }

                let m = 0; if (rh > 6) m = 1; if (rh > 12) m = 2;
                let r = this.calcSeg(m);
                let t1 = r.seg.t1, t2 = r.seg.t2;

                let fmt; if (m === 0) fmt = "CARTS (1-6)"; else if (m === 1) fmt = "OPPOSITES (7-12)"; else fmt = "DRIVERS (13-18)";
                document.getElementById('d-fmt').innerText = fmt;

                // PRESS BUTTON LOGIC
                let pBtn = '';
                const isScramble = (this.d.gameType === 'scramble');
                if (rh % 6 === 0 && !isScramble) {
                    let diff = r.w1 - r.w2;
                    if (diff !== 0) {
                        let trailing = diff > 0 ? 2 : 1;
                        let absD = Math.abs(diff);
                        let type = absD === 1 ? 1 : 2;
                        let isP = this.d.press && this.d.press[m];

                        if (isP) {
                            pBtn = `<button class="g-btn g-btn-sm" style="background:#F59E0B; color:black; margin-top:4px;" onclick="App.togglePress(${m}, ${type}, ${trailing})">PRESS ACTIVE (${isP.type === 1 ? 'WIN SEG' : 'PUSH'})</button>`;
                        } else {
                            const lbl = type === 1 ? "PRESS" : "PRESS (SAVE)";
                            pBtn = `<button class="g-btn g-btn-sm" style="background:#334155; margin-top:4px; border:1px solid #F59E0B; color:#F59E0B;" onclick="App.togglePress(${m}, ${type}, ${trailing})">${lbl}</button>`;
                        }
                    }
                }

                let stat = "ALL SQUARE";
                if (isScramble) {
                    stat = `PTS: ${r.w1} - ${r.w2}`;
                } else {
                    let d = r.w1 - r.w2;
                    if (d > 0) stat = `${this.d.ps[t1[0]].substring(0, 3)}/${this.d.ps[t1[1]].substring(0, 3)} <em style="color:#10B981">${d} UP</em>`;
                    else if (d < 0) stat = `${this.d.ps[t2[0]].substring(0, 3)}/${this.d.ps[t2[1]].substring(0, 3)} <em style="color:#10B981">${Math.abs(d)} UP</em>`;
                    else if (r.winner !== 0) {
                        if (r.winner === 1) stat = `${this.d.ps[t1[0]].substring(0, 3)}/${this.d.ps[t1[1]].substring(0, 3)} <em style="color:#10B981">WINS</em>`;
                        else stat = `${this.d.ps[t2[0]].substring(0, 3)}/${this.d.ps[t2[1]].substring(0, 3)} <em style="color:#10B981">WINS</em>`;
                    }
                }
                document.getElementById('d-status').innerHTML = stat + pBtn;

                const map = (id, pid) => {
                    this.slotMap[id] = pid;
                    const pops = this.getPops(pid, this.d.h - 1);
                    const dots = " (H)".repeat(pops);
                    const nmEl = document.getElementById('nm-' + id);
                    nmEl.innerText = this.d.ps[pid] + dots;
                    nmEl.style.color = pops > 0 ? '#F59E0B' : '#94A3B8';

                    document.getElementById('gh-' + id).innerText = "PAR " + par;
                    const sc = this.d.s[this.d.h] && this.d.s[this.d.h][pid];
                    const ec = document.getElementById('slot-' + id);
                    const es = document.getElementById('sc-' + id);
                    // Net Score logic for color: sc - pops vs par
                    if (sc) {
                        ec.classList.add('has-score');
                        es.innerText = sc;
                        const net = sc - pops;
                        es.style.color = net < par ? '#10B981' : (net > par ? '#F87171' : 'white');
                    } else { ec.classList.remove('has-score'); }
                };
                map(0, t1[0]); map(1, t1[1]);
                document.getElementById('lbl-t1').innerText = `TEAM A (${this.d.ps[t1[0]].substring(0, 3)} & ${this.d.ps[t1[1]].substring(0, 3)})`;
                map(2, t2[0]); map(3, t2[1]);
                document.getElementById('lbl-t2').innerText = `TEAM B (${this.d.ps[t2[0]].substring(0, 3)} & ${this.d.ps[t2[1]].substring(0, 3)})`;
            },

            uCard: function () {
                const c = CS[this.d.crs] || CS['cc'];
                const cardCon = document.getElementById('card-con-body');
                if (!cardCon) return;

                const build9 = (startH, label) => {
                    let hH = `<tr><th>#</th>`;
                    for (let i = startH; i < startH + 9; i++) hH += `<th>${i}</th>`;
                    hH += '<th>TOT</th></tr>';

                    let hP = '<tr><td>PAR</td>';
                    let totP = 0;
                    for (let i = startH; i < startH + 9; i++) { hP += `<td>${c.p[i - 1]}</td>`; totP += c.p[i - 1]; }
                    hP += `<td>${totP}</td></tr>`;

                    let pRows = '';
                    [0, 1, 2, 3].forEach(pIdx => {
                        let r = `<tr><td>${this.d.ps[pIdx].substring(0, 8)}</td>`;
                        let tot = 0;
                        for (let i = startH; i < startH + 9; i++) {
                            const s = (this.d.s[i] && this.d.s[i][pIdx]);
                            const par = c.p[i - 1];
                            let valHTML = '';
                            if (s) {
                                tot += s;
                                const d = s - par;
                                let cls = '';
                                if (d === -1) cls = 'sc-bird';
                                else if (d <= -2) cls = 'sc-eagle';
                                else if (d === 1) cls = 'sc-bog';
                                else if (d >= 2) cls = 'sc-dbl';
                                valHTML = `<div class="sc-val ${cls}">${s}</div>`;
                            }

                            // Handicap Dots
                            const pops = this.getPops(pIdx, i - 1);
                            if (pops > 0) {
                                let dStr = '';
                                for (let k = 0; k < pops; k++) dStr += '‚Ä¢';
                                valHTML += `<div style="font-size:16px; line-height:10px; color:#F472B6; position:absolute; bottom:2px; right:2px; letter-spacing:-2px;">${dStr}</div>`;
                            }

                            r += `<td style="position:relative;">${valHTML}</td>`;
                        }
                        r += `<td>${tot}</td></tr>`;
                        pRows += r;
                    });

                    return `<div style="margin-bottom:20px;">
                        <div style="font-size:12px; font-weight:900; color:#10B981; margin-bottom:4px;">${label}</div>
                        <div class="card-table-wrap">
                            <table><thead id="tb-head-${startH}">${hH}</thead><tbody id="tb-body-${startH}">${hP}${pRows}</tbody></table>
                        </div>
                    </div>`;
                };

                cardCon.innerHTML = build9(1, 'FRONT 9') + build9(10, 'BACK 9');

                // GROSS TOTALS SECTION
                let totHTML = '<div style="margin-top:20px; padding:12px; background:#1E293B; border:1px solid #334155; border-radius:12px;"><div style="font-size:12px; font-weight:900; color:#10B981; margin-bottom:8px; text-transform:uppercase;">Gross Totals</div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">';
                this.d.ps.forEach((p, i) => {
                    let t = 0;
                    for (let h = 1; h <= 18; h++) if (this.d.s[h] && this.d.s[h][i]) t += this.d.s[h][i];
                    totHTML += `<div style="display:flex; justify-content:space-between; align-items:center; background:#0F172A; padding:8px 12px; border-radius:8px; border:1px solid #334155;"><span style="font-size:12px; font-weight:700; color:#94A3B8; text-transform:uppercase;">${p.substring(0, 8)}</span><span style="font-size:15px; font-weight:900; color:white;">${t || '-'}</span></div>`;
                });
                totHTML += '</div></div>';
                cardCon.innerHTML += totHTML;

                const bets = { 0: 0, 1: 0, 2: 0, 3: 0 };
                const pts = { 0: 0, 1: 0, 2: 0, 3: 0 }; // Scramble Points
                let resHTML = "";
                const isScramble = (this.d.gameType === 'scramble');

                ["CARTS (1-6)", "OPPOSITES (7-12)", "DRIVERS (13-18)"].forEach((lbl, idx) => {
                    let r = this.calcSeg(idx);

                    if (isScramble) {
                        if (r.winner === 1) {
                            r.seg.t1.forEach(p => bets[p] += r.amt);
                            r.seg.t2.forEach(p => bets[p] -= r.amt);
                        } else if (r.winner === 2) {
                            r.seg.t2.forEach(p => bets[p] += r.amt);
                            r.seg.t1.forEach(p => bets[p] -= r.amt);
                        }
                    } else {
                        if (r.winner === 1) {
                            r.seg.t1.forEach(p => bets[p] += r.amt);
                            r.seg.t2.forEach(p => bets[p] -= r.amt);
                        } else if (r.winner === 2) {
                            r.seg.t2.forEach(p => bets[p] += r.amt);
                            r.seg.t1.forEach(p => bets[p] -= r.amt);
                        }
                    }

                    resHTML += `<div style="margin-bottom:16px;">`;
                    let wTxt = "ALL SQUARE";
                    let wCol = "white";

                    if (isScramble) {
                        if (r.winner === 1) { wTxt = `${this.d.ps[r.seg.t1[0]]}/${this.d.ps[r.seg.t1[1]]} WIN BLOCK (${r.w1} pts)`; wCol = "#10B981"; }
                        else if (r.winner === 2) { wTxt = `${this.d.ps[r.seg.t2[0]]}/${this.d.ps[r.seg.t2[1]]} WIN BLOCK (${r.w2} pts)`; wCol = "#F59E0B"; }
                        else { wTxt = `BLOCK TIED (${r.w1} pts each)`; }
                    } else {
                        if (r.winner === 1) { wTxt = `${this.d.ps[r.seg.t1[0]]}/${this.d.ps[r.seg.t1[1]]} WIN $${r.amt}`; wCol = "#10B981"; }
                        if (r.winner === 2) { wTxt = `${this.d.ps[r.seg.t2[0]]}/${this.d.ps[r.seg.t2[1]]} WIN $${r.amt}`; wCol = "#F59E0B"; }
                    }

                    // Press Badge (Only for COD)
                    let pBadge = "";
                    if (!isScramble && r.press) {
                        if (r.winner === r.press.team) pBadge = ` <span style="color:#F472B6; font-size:11px;">üî• PRESS WON</span>`;
                        else if (r.winner === 0 && r.press.type === 2) pBadge = ` <span style="color:#94A3B8; font-size:11px;">üõ°Ô∏è SAVED</span>`;
                        else if (r.winner !== 0 && r.winner !== r.press.team) pBadge = ` <span style="color:#F87171; font-size:11px;">üíÄ PRESS LOST</span>`;
                    }

                    resHTML += `<div style="font-weight:900; color:#94A3B8; font-size:11px; text-transform:uppercase; margin-bottom:2px;">${lbl}</div>`;
                    resHTML += `<div style="font-size:14px; font-weight:900; color:${wCol}; margin-bottom:8px; border-bottom:1px solid #334155; padding-bottom:4px;">${wTxt}${pBadge}</div>`;


                    // Hole Badges
                    resHTML += `<div style="display:flex; flex-wrap:wrap; gap:6px;">`;
                    // Regenerate Holes Array for this segment
                    const sRH = (idx * 6) + 1;
                    const hArr = [];
                    for (let k = 0; k < 6; k++) {
                        let rh = sRH + k; let absH = rh;
                        if (this.d.start === 10) { if (rh <= 9) absH = rh + 9; else absH = rh - 9; }
                        hArr.push(absH);
                    }

                    hArr.forEach(h => {
                        const s = this.d.s[h];
                        if (!s || Object.keys(s).length < 4) return;

                        const p1a = r.seg.t1[0], p1b = r.seg.t1[1];
                        const p2a = r.seg.t2[0], p2b = r.seg.t2[1];

                        const n1a = s[p1a] - this.getPops(p1a, h - 1);
                        const n1b = s[p1b] - this.getPops(p1b, h - 1);
                        const n2a = s[p2a] - this.getPops(p2a, h - 1);
                        const n2b = s[p2b] - this.getPops(p2b, h - 1);

                        const best1 = Math.min(n1a, n1b);
                        const best2 = Math.min(n2a, n2b);

                        let bStyle = "background:#334155; color:#94A3B8;";
                        let bTxt = `H${h}`;
                        if (best1 < best2) {
                            bStyle = "background:#10B981; color:#064E3B;"; // Green
                            let pName = (n1a === best1) ? this.d.ps[p1a] : this.d.ps[p1b];
                            if (n1a === best1 && n1b === best1) pName = "Team";
                            bTxt = `H${h}: ${pName.substring(0, 3)} (${best1})`;
                        } else if (best2 < best1) {
                            bStyle = "background:#F59E0B; color:#78350F;"; // Amber
                            let pName = (n2a === best2) ? this.d.ps[p2a] : this.d.ps[p2b];
                            if (n2a === best2 && n2b === best2) pName = "Team";
                            bTxt = `H${h}: ${pName.substring(0, 3)} (${best2})`;
                        } else {
                            // Tie
                            bTxt = `H${h}: - (${best1})`;
                        }
                        resHTML += `<div style="${bStyle} padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700;">${bTxt}</div>`;
                    });
                    resHTML += `</div></div>`;
                });

                if (isScramble) {
                    resHTML += `<div style="margin-top:12px; border-top:1px solid #334155; padding-top:8px;"><div style="font-size:11px; font-weight:900; color:white; margin-bottom:4px;">SCRAMBLE TOTALS (NET)</div>`;
                    [0, 1, 2, 3].forEach(i => { resHTML += `<div style="display:flex; justify-content:space-between; font-size:13px; color:#cbd5e1; padding:2px 0;"><span>${this.d.ps[i]}</span><span style="color:${bets[i] >= 0 ? '#10B981' : '#F87171'}">${bets[i] >= 0 ? '+' : ''}$${bets[i]}</span></div>` });
                    resHTML += `</div>`;
                } else {
                    resHTML += `<div style="margin-top:12px; border-top:1px solid #334155; padding-top:8px;"><div style="font-size:11px; font-weight:900; color:white; margin-bottom:4px;">NET TOTALS</div>`;
                    [0, 1, 2, 3].forEach(i => { resHTML += `<div style="display:flex; justify-content:space-between; font-size:13px; color:#cbd5e1; padding:2px 0;"><span>${this.d.ps[i]}</span><span style="color:${bets[i] >= 0 ? '#10B981' : '#F87171'}">${bets[i] >= 0 ? '+' : ''}$${bets[i]}</span></div>` });
                    resHTML += `</div>`;
                }

                document.getElementById('res-txt').innerHTML = resHTML;

                const btn = document.getElementById('hist-btn');
                if (btn) {
                    const exists = this.d.history.some(h => h.id === this.d.gameId);
                    if (exists || Object.keys(this.d.s).length === 0) { btn.disabled = true; btn.innerText = "HISTORY SAVED"; btn.style.background = "#334155"; }
                    else { btn.disabled = false; btn.innerText = "SAVE TO HISTORY"; btn.style.background = "#10B981"; }
                }
            },

            share: async function () {
                const btn = document.getElementById('sms-btn');
                try {
                    btn.innerText = "GENERATING PREVIEW...";

                    const c = CS[this.d.crs] || CS['cc'];
                    const ps = this.d.ps;

                    const isScramble = (this.d.gameType === 'scramble');
                    const bets = { 0: 0, 1: 0, 2: 0, 3: 0 };
                    const pts = { 0: 0, 1: 0, 2: 0, 3: 0 };
                    const segRes = [];

                    [0, 1, 2].forEach(idx => {
                        let r = this.calcSeg(idx);
                        let wStr = "";

                        if (isScramble) {
                            if (r.winner === 1) {
                                wStr = `${ps[r.seg.t1[0]]}/${ps[r.seg.t1[1]]} (+$${r.amt})`;
                                r.seg.t1.forEach(p => bets[p] += r.amt);
                                r.seg.t2.forEach(p => bets[p] -= r.amt);
                            } else if (r.winner === 2) {
                                wStr = `${ps[r.seg.t2[0]]}/${ps[r.seg.t2[1]]} (+$${r.amt})`;
                                r.seg.t2.forEach(p => bets[p] += r.amt);
                                r.seg.t1.forEach(p => bets[p] -= r.amt);
                            }
                            if (r.winner === 0) wStr = `TIE (${r.w1}-${r.w2})`;
                            else wStr += ` (${Math.max(r.w1, r.w2)} pts)`;

                            segRes.push({ name: ["BLOCK 1 (1-6)", "BLOCK 2 (7-12)", "BLOCK 3 (13-18)"][idx], val: wStr });
                        } else {
                            // COD Logic
                            wStr = "TIE";
                            if (r.winner === 1) {
                                wStr = `${ps[r.seg.t1[0]]}/${ps[r.seg.t1[1]]} (+$${r.amt})`;
                                r.seg.t1.forEach(p => bets[p] += r.amt);
                                r.seg.t2.forEach(p => bets[p] -= r.amt);
                            } else if (r.winner === 2) {
                                wStr = `${ps[r.seg.t2[0]]}/${ps[r.seg.t2[1]]} (+$${r.amt})`;
                                r.seg.t2.forEach(p => bets[p] += r.amt);
                                r.seg.t1.forEach(p => bets[p] -= r.amt);
                            }
                            let pStatus = "";
                            if (r.press && r.winner === r.press.team) pStatus = " üî• PRESS WON";
                            else if (r.press && r.winner === 0 && r.press.type === 2) pStatus = " üõ°Ô∏è SAVED";
                            else if (r.press && r.winner !== r.press.team && r.winner !== 0) pStatus = " üíÄ PRESS LOST";
                            segRes.push({ name: ["CARTS", "OPPOSITES", "DRIVERS"][idx], val: wStr + pStatus });
                        }
                    });

                    // 2. Build Capture HTML
                    const sn = document.getElementById('share-node');
                    let finHTML = '';

                    if (isScramble) {
                        [0, 1, 2, 3].forEach(i => {
                            const v = bets[i];
                            finHTML += `<div class="sn-row"><span>${ps[i]}</span><span class="${v >= 0 ? 'sn-hl' : 'sn-neg'}">${v >= 0 ? '+' : ''}$${v}</span></div>`;
                        });
                    } else {
                        [0, 1, 2, 3].forEach(i => {
                            const v = bets[i];
                            finHTML += `<div class="sn-row"><span>${ps[i]}</span><span class="${v >= 0 ? 'sn-hl' : 'sn-neg'}">${v >= 0 ? '+' : ''}$${v}</span></div>`;
                        });
                    }

                    let segHTML = '';
                    segRes.forEach(s => {
                        segHTML += `<div class="sn-row" style="font-size:14px;"><span style="color:#94A3B8">${s.name}</span><span>${s.val}</span></div>`;
                    });

                    // 3. Scorecard Grid (GROSS & NET)
                    const buildCard_v2 = (start, lbl, isNet) => {
                        // Standard Theme Shared by Both
                        const theme = '#10B981';
                        const subC = '#334155';
                        const bgHead = '#0F172A';
                        const bgBody = '#1E293B';

                        let h = `<div style="margin-top:16px; font-size:11px; font-weight:900; color:${theme}; margin-bottom:4px; text-transform:uppercase;">${lbl}</div><div class="sn-grid" style="border-color:${subC};">`;

                        // HEADER
                        h += `<div class="sn-g-row head" style="background:${bgHead}; border-color:${subC};">`;
                        h += `<div class="sn-col nm" style="border-color:${subC};">PLY</div>`;
                        for (let i = start; i < start + 9; i++) h += `<div class="sn-col h" style="border-color:${subC};">${i}</div>`;
                        h += `<div class="sn-col tot" style="border-color:${subC}; color:${theme};">TOT</div>`;
                        if (start === 10) h += `<div class="sn-col rnd" style="border-color:${subC}; color:${theme};">RND</div>`;
                        h += `</div>`;

                        // ROWS
                        [0, 1, 2, 3].forEach(pIdx => {
                            let pName = ps[pIdx].substring(0, 3).toUpperCase();
                            h += `<div class="sn-g-row body" style="border-color:${subC}; background:${bgBody};">`;
                            h += `<div class="sn-col nm" style="border-color:${subC};">${pName}</div>`;

                            let segTot = 0;
                            // Holes
                            for (let i = start; i < start + 9; i++) {
                                const s = (this.d.s[i] && this.d.s[i][pIdx]);
                                let disp = '-';
                                let tCol = 'white'; let bStyle = '';

                                if (typeof s === 'number') {
                                    // Net Logic
                                    const pops = isNet ? this.getPops(pIdx, i - 1, true) : 0;
                                    const val = s - pops;
                                    disp = val;
                                    segTot += val;

                                    const par = c.p[i - 1];
                                    const d = val - par;

                                    // 1. Determine Text Color (Lime if Stroked in Net, else White)
                                    if (isNet && pops > 0) tCol = '#bef264'; // LIME

                                    // 2. Determine Border (Birdie/Bogey)
                                    if (d <= -1) {
                                        const bCol = '#10B981'; // Green
                                        bStyle = `border:${d === -1 ? '1px solid' : '3px double'} ${bCol}; border-radius:50%;`;
                                        // If Net card and stroke, keep Lime text. Else use Green.
                                        if (!isNet || pops === 0) tCol = bCol;
                                    } else if (d >= 1) {
                                        const bCol = '#F87171'; // Red
                                        bStyle = `border:${d === 1 ? '1px solid' : '3px double'} ${bCol};`;
                                        if (!isNet || pops === 0) tCol = bCol;
                                    }
                                }
                                h += `<div class="sn-col sc" style="color:${tCol}; border-color:${subC};"><div class="sn-ball" style="${bStyle}">${disp}</div></div>`;
                            }

                            h += `<div class="sn-col tot" style="border-color:${subC}; color:${theme};">${segTot}</div>`;
                            if (start === 10) {
                                let grand = 0;
                                for (let x = 1; x <= 18; x++) {
                                    const rs = this.d.s[x] && this.d.s[x][pIdx];
                                    if (typeof rs === 'number') {
                                        grand += (isNet ? (rs - this.getPops(pIdx, x - 1)) : rs);
                                    }
                                }
                                h += `<div class="sn-col rnd" style="border-color:${subC}; color:${theme};">${grand}</div>`;
                            }
                            h += `</div>`;
                        });
                        h += `</div>`;
                        return h;
                    };

                    sn.innerHTML = `
                        <div class="sn-head">${c.n}</div>
                        <div class="sn-sub">${new Date().toLocaleDateString()} ‚Ä¢ ${this.d.tee.toUpperCase()} ‚Ä¢ COD GOLF v241</div>
                        <div class="sn-sect">
                            <div class="sn-sect-tl">FINANCIALS</div>
                            ${finHTML}
                        </div>
                        <div class="sn-sect">
                            <div class="sn-sect-tl">MATCH RESULTS</div>
                            ${segHTML}
                        </div>
                        <div class="sn-sect">
                             <div class="sn-sect-tl">GROSS SCORECARD</div>
                             ${buildCard_v2(1, 'FRONT 9', false)}
                             ${buildCard_v2(10, 'BACK 9', false)}
                        </div>
                        <div class="sn-sect">
                             <div class="sn-sect-tl">NET SCORECARD</div>
                             ${buildCard_v2(1, 'FRONT 9 (NET)', true)}
                             ${buildCard_v2(10, 'BACK 9 (NET)', true)}
                        </div>
                    `;

                    // Generate Image
                    await new Promise(r => setTimeout(r, 200));
                    const canvas = await html2canvas(sn, { backgroundColor: '#0F172A', scale: 2 });

                    canvas.toBlob(async (blob) => {
                        if (!blob) throw new Error("Canvas Blob Failed");
                        this.shareBlob = blob;
                        const url = URL.createObjectURL(blob);

                        document.getElementById('sp-img').src = url;
                        document.getElementById('share-preview-modal').classList.add('active');
                        btn.innerText = "SHARE IMAGE SUMMARY";

                    }, 'image/png');

                } catch (e) {
                    alert("Image Share Error: " + e.message);
                    btn.innerText = "SHARE ERROR";
                }
            },

            closeSharePreview: function () {
                document.getElementById('share-preview-modal').classList.remove('active');
            },

            doShareParams: async function () {
                if (!this.shareBlob) return;
                const bets = { 0: 0, 1: 0, 2: 0, 3: 0 };

                [0, 1, 2].forEach(idx => {
                    let r = this.calcSeg(idx);
                    if (r.winner === 1) {
                        r.seg.t1.forEach(p => bets[p] += r.amt);
                        r.seg.t2.forEach(p => bets[p] -= r.amt);
                    } else if (r.winner === 2) {
                        r.seg.t2.forEach(p => bets[p] += r.amt);
                        r.seg.t1.forEach(p => bets[p] -= r.amt);
                    }
                });

                // 2. Who Pays Who
                let debtors = [], creditors = [];
                [0, 1, 2, 3].forEach(i => {
                    if (bets[i] < 0) debtors.push({ id: i, val: Math.abs(bets[i]) });
                    if (bets[i] > 0) creditors.push({ id: i, val: bets[i] });
                });

                let sett = "";
                if (debtors.length === 0) sett = "\nALL SQUARE";
                else {
                    sett = "\n\nPAYOUTS:\n";
                    debtors.forEach(d => {
                        while (d.val > 0 && creditors.length > 0) {
                            let c = creditors[0];
                            let amt = Math.min(d.val, c.val);
                            sett += `${this.d.ps[d.id]} pays ${this.d.ps[c.id]} $${amt}\n`;
                            d.val -= amt;
                            c.val -= amt;
                            if (c.val === 0) creditors.shift();
                        }
                    });
                }

                const file = new File([this.shareBlob], "cod_scorecard.png", { type: "image/png" });
                const cName = CS[this.d.crs] ? CS[this.d.crs].n : 'COD Golf';
                const sText = `Results from ${cName} on ${new Date().toLocaleDateString()}${sett}`;

                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'COD Golf Summary',
                            text: sText
                        });
                    } catch (e) {
                        if (e.name !== 'AbortError') alert("Share Failed: " + e.message);
                    }
                } else {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(this.shareBlob);
                    a.download = "cod_scorecard.png";
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                }
            },


            saveToHistory: function () {
                if (!this.d.s || Object.keys(this.d.s).length === 0) return;
                const c = CS[this.d.crs] || CS['cc'];
                const bets = { 0: 0, 1: 0, 2: 0, 3: 0 };

                [0, 1, 2].forEach(idx => {
                    let r = this.calcSeg(idx);
                    if (r.winner === 1) {
                        r.seg.t1.forEach(p => bets[p] += r.amt);
                        r.seg.t2.forEach(p => bets[p] -= r.amt);
                    } else if (r.winner === 2) {
                        r.seg.t2.forEach(p => bets[p] += r.amt);
                        r.seg.t1.forEach(p => bets[p] -= r.amt);
                    }
                });
                const rec = { id: Date.now(), date: new Date().toLocaleDateString(), course: c.n, ps: this.d.ps, net: [0, 1, 2, 3].map(i => bets[i]) };
                this.d.gameId = rec.id;
                this.d.history.push(rec);
                this.save();
                this.uCard();
                this.renderHistory();
            },

            renderHistory: function () {
                const div = document.getElementById('hist-list');
                const careerDiv = document.getElementById('career-earnings');
                if (!div || !careerDiv) return;

                const stats = {};
                const labels = {}; // Store display name

                this.d.history.forEach(r => {
                    r.ps.forEach((p, i) => {
                        const k = p.trim().toUpperCase();
                        if (!stats[k]) {
                            stats[k] = 0;
                            labels[k] = p.trim();
                        }
                        stats[k] += r.net[i];

                        // If we have a stored label that is ALL CAPS, but this new one isn't, prefer the new one (e.g. switch DAN -> Dan)
                        // This helps fix the "ugly" all caps history if a user corrected it later.
                        const curLbl = labels[k];
                        const newLbl = p.trim();
                        if (curLbl === k && newLbl !== k) {
                            labels[k] = newLbl;
                        }
                    });
                });

                let cHTML = '';
                // Sort by earnings matching the case-insensitive aggregation
                Object.keys(stats).sort((a, b) => stats[b] - stats[a]).forEach(k => {
                    const v = stats[k];
                    const pName = labels[k];
                    cHTML += `<span style="display:inline-block; margin-right:12px; color:${v >= 0 ? '#10B981' : '#F87171'}"><strong>${pName}:</strong> ${v >= 0 ? '+' : ''}${v}</span>`;
                });
                if (cHTML === '') cHTML = 'No data yet.';

                careerDiv.innerHTML = 'Updating...';
                setTimeout(() => { careerDiv.innerHTML = cHTML; }, 10);

                let hH = '';
                const hist = this.d.history.slice().reverse();

                const listClass = this.histEdit ? 'hist-edit-mode' : '';
                div.className = listClass;

                hist.forEach(r => {
                    let netS = r.ps.map((p, i) => `${p}:${r.net[i] >= 0 ? '+' : ''}${r.net[i]}`).join(', ');
                    hH += `<div class="hist-item">
                        <input type="checkbox" class="hist-chk" onchange="App.onChk(${r.id}, this)">
                        <div style="flex:1">
                            <div style="font-weight:bold; color:white;">${r.date} - ${r.course}</div>
                            <div style="font-size:11px;">${netS}</div>
                        </div>
                    </div>`;
                });

                if (hH === '') hH = '<div style="padding:10px; color:#64748b; font-style:italic;">No history yet.</div>';
                div.innerHTML = hH;
            },

            onChk: function (id, el) {
                if (el.checked) {
                    if (!this.selIds.includes(id)) this.selIds.push(id);
                } else {
                    this.selIds = this.selIds.filter(x => x !== id);
                }
                const btn = document.getElementById('hist-edit-btn');
                btn.innerText = `DELETE (${this.selIds.length})`;
            },

            handleManageClick: function () {
                if (!this.histEdit) {
                    this.histEdit = true;
                    this.selIds = [];
                    const btn = document.getElementById('hist-edit-btn');
                    btn.innerText = "DELETE (0)";
                    btn.style.backgroundColor = "#EF4444";
                    this.renderHistory();
                } else {
                    this.doDelete();
                }
            },

            doDelete: function () {
                if (this.selIds.length === 0) {
                    this.exitEditMode();
                    return;
                }
                alert(`Deleting ${this.selIds.length} items...`);
                this.d.history = this.d.history.filter(h => !this.selIds.includes(h.id));
                this.save();
                this.exitEditMode();
            },

            exitEditMode: function () {
                this.histEdit = false;
                this.selIds = [];
                const btn = document.getElementById('hist-edit-btn');
                btn.innerText = "MANAGE";
                btn.style.backgroundColor = "#334155";

                this.renderHistory();
            }
        };
        window.addEventListener('load', () => App.init());
        window.App = App;
    </script>
</body>

</html>